import{j as e}from"./ui-vendor-BO3EQrMK-mjd3dogn.js";import{r as t,R as s}from"./react-vendor-D1R0t5S0-mjd3dogn.js";import{C as a,a as n,b as r,c as i}from"./card-jeNxgMYk-mjd3dogn.js";import{T as d}from"./trending-up-B0a-0y1l-mjd3dogn.js";import{T as l}from"./trending-down-MCtSAEQe-mjd3dogn.js";import{c as o,j as m,B as c,s as p,N as u,d as x,u as h,l as y,I as j,k as g,e as f}from"./index-Ta7FH5xW-mjd3dogn.js";import{A as b,b as N,a as v}from"./avatar-HCmfb6Ad-mjd3dogn.js";import{D as w,a as _,b as P,c as S,e as C,f as M}from"./dialog-BcLamxvL-mjd3dogn.js";import{L as k}from"./loader-circle-C0Dqayt8-mjd3dogn.js";import{C as I}from"./circle-check-CNnkiDfZ-mjd3dogn.js";import{C as O}from"./clock-CbBGjTQx-mjd3dogn.js";import{E as U}from"./external-link-CqAT5ABV-mjd3dogn.js";import{g as D,C as B}from"./select-CMjqEsxb-mjd3dogn.js";import{B as T}from"./badge-DyE_ZUPM-mjd3dogn.js";import{I as A}from"./input-DsI2n-oJ-mjd3dogn.js";import{L as F}from"./label-D_iG0y88-mjd3dogn.js";import{w as $,L as E}from"./SettingsMenu-DFNATHGY-mjd3dogn.js";import{C as z}from"./circle-check-big-Bvor9_sf-mjd3dogn.js";import{l as Y,y as q,z as L}from"./TripDetailModals-BpnQZ47b-mjd3dogn.js";import{a as R}from"./utils-DD44zzh--mjd3dogn.js";import{C as V}from"./checkbox-DB2Rf35T-mjd3dogn.js";import{U as Z}from"./users-B07yK8Y7-mjd3dogn.js";import{u as H}from"./useSuperAdmin-CWSn9Z4T-mjd3dogn.js";import{a as J}from"./tripsData-DKwZ96V_-mjd3dogn.js";import{L as K,t as Q}from"./tripConverter-C1IUbOIF-mjd3dogn.js";import{A as W}from"./AuthModal-BKw70HSh-mjd3dogn.js";import"./supabase-DyX-XggK-mjd3dogn.js";import"./SavedRecommendations-D-6cIfyL-mjd3dogn.js";import"./useSavedRecommendations-DTox9Xl2-mjd3dogn.js";import"./map-pin-BtCU-LeS-mjd3dogn.js";import"./plus-Dhwa7sZY-mjd3dogn.js";import"./pro-CZgaTEEg-mjd3dogn.js";import"./BillingSection-CjHrdMm3-mjd3dogn.js";import"./building-QMpp1aWF-mjd3dogn.js";import"./camera-AJLsIMdA-mjd3dogn.js";import"./user-DFuJ2ZP3-mjd3dogn.js";import"./shield-DGBvlKQi-mjd3dogn.js";import"./zap-LZcBFzwj-mjd3dogn.js";import"./switch-GKuTbu---mjd3dogn.js";import"./mail-BdBVrsyz-mjd3dogn.js";import"./userPreferencesService-DregIO64-mjd3dogn.js";import"./calendar-C9K0fVga-mjd3dogn.js";import"./archive-zX2FvEif-mjd3dogn.js";import"./eye-BNDPAvT6-mjd3dogn.js";import"./dropdown-menu-BXaKb4pk-mjd3dogn.js";import"./chevron-right-DKRZr0Ps-mjd3dogn.js";import"./eventsMockData-BWXZ-nj7-mjd3dogn.js";import"./calendar-ylgcJK3b-mjd3dogn.js";import"./chevron-left-C1xtDQ_l-mjd3dogn.js";import"./progress-D31nnzej-mjd3dogn.js";import"./textarea-BudkfAn8-mjd3dogn.js";import"./googlePlacesNew-Dl7cAwDK-mjd3dogn.js";import"./circle-alert-CX60mGhN-mjd3dogn.js";import"./chart-column-DOJCLy2J-mjd3dogn.js";import"./charts-CLK9EMgA-mjd3dogn.js";import"./share-2-DwO-SOoB-mjd3dogn.js";import"./arrow-left-Biq1qnK6-mjd3dogn.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=o("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]),G=({summary:t})=>{const s=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:t.baseCurrency||"USD"}).format(e);return e.jsx(a,{className:"bg-gradient-to-br from-primary/10 to-primary/5 border-primary/20 rounded-lg",children:e.jsx(n,{className:"py-3 px-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-center space-y-0.5",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"You Owe"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:s(t.totalOwed)})]}),e.jsxs("div",{className:"text-center space-y-0.5",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"You Are Owed"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:s(t.totalOwedToYou)})]}),e.jsxs("div",{className:"text-center space-y-0.5",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Net Balance"}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-2xl font-bold "+(t.netBalance>0?"text-green-600":t.netBalance<0?"text-orange-600":"text-muted-foreground"),children:[t.netBalance>0?e.jsx(d,{className:"w-5 h-5"}):t.netBalance<0?e.jsx(l,{className:"w-5 h-5"}):e.jsx(X,{className:"w-5 h-5"}),s(Math.abs(t.netBalance))]})]})]})})})},ee=({open:s,onOpenChange:a,balance:n,tripId:r})=>{const{toast:i}=m(),[d,l]=t.useState(!1),[o,u]=t.useState(null),x=async()=>{var e,t;l(!0),u(null);try{const{data:{user:s}}=await p.auth.getUser();if(!s)throw new Error("Not authenticated");const r=n.amountOwed<0,d=n.unsettledPayments.map(e=>e.paymentId);if(r){const{error:t}=await p.from("payment_splits").update({confirmation_status:"pending",settlement_method:(null==(e=n.preferredPaymentMethod)?void 0:e.type)||"other"}).in("payment_message_id",d).eq("debtor_user_id",s.id).eq("is_settled",!1);if(t)throw t;i({title:"Payment Marked as Paid",description:`${n.userName} will be notified to confirm receipt`})}else{const{error:e}=await p.from("payment_splits").update({is_settled:!0,settled_at:(new Date).toISOString(),confirmation_status:"confirmed",confirmed_by:s.id,confirmed_at:(new Date).toISOString(),settlement_method:(null==(t=n.preferredPaymentMethod)?void 0:t.type)||"other"}).in("payment_message_id",d).eq("debtor_user_id",n.userId).eq("is_settled",!1);if(e)throw e;i({title:"Payment Settled",description:`Marked payment from ${n.userName} as settled`})}a(!1),window.location.reload()}catch(s){const e=s instanceof Error?s.message:"Failed to settle payment";u(e),i({title:"Error",description:e+". Please try again.",variant:"destructive"})}finally{l(!1)}},h=n.amountOwed<0;return e.jsx(w,{open:s,onOpenChange:a,children:e.jsxs(_,{children:[e.jsxs(P,{children:[e.jsx(S,{children:"Settle Payment"}),e.jsx(C,{children:"Confirm that this payment has been completed"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Amount:"}),e.jsx("span",{className:"text-lg font-semibold",children:(y=Math.abs(n.amountOwed),new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(Math.abs(y)))})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:h?"Paying to:":"Receiving from:"}),e.jsx("span",{className:"font-medium",children:n.userName})]}),n.preferredPaymentMethod&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Method:"}),e.jsx("span",{className:"font-medium",children:n.preferredPaymentMethod.type.charAt(0).toUpperCase()+n.preferredPaymentMethod.type.slice(1)})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-4",children:"This will mark all associated payments as settled. This action cannot be undone."}),o&&e.jsxs("div",{className:"mt-4 p-3 bg-destructive/10 border border-destructive/30 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-destructive font-medium",children:["Error: ",o]}),e.jsx(c,{variant:"outline",size:"sm",onClick:x,disabled:d,className:"mt-2 w-full",children:"Retry Settlement"})]})]}),e.jsxs(M,{children:[e.jsx(c,{variant:"outline",onClick:()=>a(!1),disabled:d,children:"Cancel"}),e.jsxs(c,{onClick:x,disabled:d,children:[d&&e.jsx(k,{className:"w-4 h-4 mr-2 animate-spin"}),d?"Settling...":"Confirm Settlement"]})]})]})});var y},te=({open:s,onOpenChange:a,balance:n,tripId:r})=>{const[i,d]=t.useState(!1),[l,o]=t.useState(null),m=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(Math.abs(e)),x=async()=>{d(!0),o(null);try{const{data:{user:e}}=await p.auth.getUser();if(!e)throw new Error("Not authenticated");const{error:t}=await p.from("payment_splits").update({confirmation_status:"confirmed",confirmed_by:e.id,confirmed_at:(new Date).toISOString(),is_settled:!0,settled_at:(new Date).toISOString()}).eq("debtor_user_id",n.userId).eq("confirmation_status","pending");if(t)throw t;u({title:"Payment Confirmed",description:`You've confirmed receiving ${m(Math.abs(n.amountOwed))} from ${n.userName}`}),a(!1),window.location.reload()}catch(e){const t=e instanceof Error?e.message:"Failed to confirm payment";o(t),u({title:"Confirmation Failed",description:t+". Please try again.",variant:"destructive"})}finally{d(!1)}};return e.jsx(w,{open:s,onOpenChange:a,children:e.jsxs(_,{className:"sm:max-w-md",children:[e.jsxs(P,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5 text-green-500"}),"Confirm Payment Received"]}),e.jsxs(C,{children:[n.userName," marked their payment as complete. Please confirm you've received the money."]})]}),e.jsxs("div",{className:"py-4",children:[e.jsxs("div",{className:"bg-muted rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Amount:"}),e.jsx("span",{className:"font-semibold",children:m(Math.abs(n.amountOwed))})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"From:"}),e.jsx("span",{className:"font-medium",children:n.userName})]}),n.preferredPaymentMethod&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Via:"}),e.jsx("span",{className:"font-medium capitalize",children:n.preferredPaymentMethod.type})]})]}),e.jsx("div",{className:"mt-4 text-sm text-muted-foreground",children:"By confirming, you're acknowledging that you've received this payment and the transaction will be marked as complete."}),l&&e.jsxs("div",{className:"mt-4 p-3 bg-destructive/10 border border-destructive/30 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-destructive font-medium",children:["Error: ",l]}),e.jsx(c,{variant:"outline",size:"sm",onClick:x,disabled:i,className:"mt-2 w-full",children:"Retry Confirmation"})]})]}),e.jsxs(M,{className:"flex gap-2",children:[e.jsx(c,{type:"button",variant:"outline",onClick:()=>{a(!1),u({title:"Payment Still Pending",description:"The payment confirmation request will remain open."})},disabled:i,children:"Leave Pending"}),e.jsx(c,{type:"button",onClick:x,disabled:i,className:"bg-green-600 hover:bg-green-700",children:i?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"w-4 h-4 mr-2 animate-spin"}),"Confirming..."]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Confirm Received"]})})]})]})})},se=({balance:s,tripId:r})=>{const[i,d]=t.useState(!1),[l,o]=t.useState(!1),[m,p]=t.useState(!1),u="pending"===s.confirmationStatus,x=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(Math.abs(e)),h=s.amountOwed<0,y=Math.abs(s.amountOwed),j=(()=>{if(!s.preferredPaymentMethod)return null;const e=s.preferredPaymentMethod,t=e.identifier;switch(e.type){case"venmo":return`venmo://paycharge?txn=pay&recipients=${encodeURIComponent(t)}&amount=${y.toFixed(2)}`;case"cashapp":return`https://cash.app/${encodeURIComponent(t)}/${y.toFixed(2)}`;case"paypal":return`https://paypal.me/${encodeURIComponent(t)}/${y.toFixed(2)}`;default:return null}})();return e.jsxs(e.Fragment,{children:[e.jsx(a,{className:(h?"border-orange-600/30":"border-green-600/30")+" rounded-lg",children:e.jsxs(n,{className:"py-3 px-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsxs(b,{className:"w-10 h-10 flex-shrink-0",children:[e.jsx(N,{src:s.avatar,alt:s.userName}),e.jsx(v,{children:s.userName.charAt(0)})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-semibold text-foreground truncate",children:s.userName}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:(()=>{if(!s.preferredPaymentMethod)return"No payment method set";const e=s.preferredPaymentMethod;return`${{venmo:"Venmo",cashapp:"Cash App",zelle:"Zelle",paypal:"PayPal",applecash:"Apple Cash"}[e.type]||e.type}: ${e.identifier}`})()})]})]}),u&&!h?e.jsxs(c,{size:"sm",className:"text-xs px-2 py-1 h-auto flex-shrink-0 bg-orange-600 hover:bg-orange-700",onClick:()=>p(!0),children:[e.jsx(O,{className:"w-3 h-3 mr-1"}),"Confirm Payment"]}):h?e.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[j&&e.jsxs(c,{size:"sm",className:"text-xs px-2 py-1 h-auto",onClick:()=>window.open(j,"_blank"),children:[e.jsx(U,{className:"w-3 h-3 mr-1"}),"Pay Now"]}),e.jsx(c,{size:"sm",variant:"outline",className:"text-xs px-2 py-1 h-auto",onClick:()=>o(!0),children:"Mark as Paid"})]}):e.jsx(c,{size:"sm",variant:"outline",className:"text-xs px-2 py-1 h-auto flex-shrink-0",onClick:()=>o(!0),children:"Mark as Paid"}),e.jsxs("div",{className:"text-right flex-shrink-0",children:[e.jsx("p",{className:"text-sm font-semibold "+(h?"text-orange-600":"text-green-600"),children:h?"You owe":"Owes you"}),e.jsx("p",{className:"text-lg font-bold",children:x(y)})]}),e.jsx(c,{size:"sm",variant:"ghost",className:"flex-shrink-0 h-auto p-1",onClick:()=>d(!i),children:i?e.jsx(D,{className:"w-4 h-4"}):e.jsx(B,{className:"w-4 h-4"})})]}),i&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-border space-y-1.5",children:[e.jsx("h5",{className:"font-medium text-sm text-muted-foreground mb-2",children:"Individual Payments"}),s.unsettledPayments.length>0?s.unsettledPayments.map((t,s)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:t.description}),e.jsx("span",{className:t.amount<0?"text-orange-600":"text-green-600",children:x(Math.abs(t.amount))})]},s)):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No itemized breakdown available"})]})]})}),e.jsx(ee,{open:l,onOpenChange:o,balance:s,tripId:r}),e.jsx(te,{open:m,onOpenChange:p,balance:s,tripId:r})]})},ae=({tripId:s,onPaymentUpdated:d})=>{const[l,o]=t.useState([]),[u,f]=t.useState(!0),[b,N]=t.useState(null),[v,C]=t.useState(""),[I,U]=t.useState(""),[D,B]=t.useState(null),{isDemoMode:E}=x(),{user:q}=h(),{toast:L}=m(),V=async()=>{f(!0);try{let e=await $.getTripPaymentMessages(s);const t=/^\d+$/.test(s),a=parseInt(s),n=E&&t&&a>=1&&a<=12;if(0===e.length&&n){e=g.getMockPayments(s,!1).map(e=>({id:e.id,tripId:e.trip_id,messageId:null,amount:e.amount,currency:e.currency,description:e.description,splitCount:e.split_count,splitParticipants:e.split_participants,paymentMethods:e.payment_methods,createdBy:e.created_by,createdAt:e.created_at,isSettled:e.is_settled}))}const r=g.getSessionPayments(s);if(r.length>0){const t=r.map(e=>({id:e.id,tripId:e.trip_id,messageId:null,amount:e.amount,currency:e.currency,description:e.description,splitCount:e.split_count,splitParticipants:e.split_participants,paymentMethods:e.payment_methods,createdBy:e.created_by,createdAt:e.created_at,isSettled:e.is_settled}));e=[...e,...t]}const i=e.filter(e=>e.isSettled);i.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime());const d=[...new Set(i.filter(e=>"demo-user"!==e.createdBy).map(e=>e.createdBy))],l=new Map;if(d.length>0){const{data:e}=await p.from("profiles").select("user_id, display_name").in("user_id",d);(e||[]).forEach(e=>{l.set(e.user_id,e.display_name||"Trip member")})}const m=i.map(e=>({id:e.id,description:e.description,amount:e.amount,currency:e.currency,splitCount:e.splitCount,createdBy:e.createdBy,createdAt:e.createdAt,createdByName:"demo-user"===e.createdBy?"Demo User":l.get(e.createdBy)||"Trip member",isSettled:e.isSettled}));o(m)}catch(e){const t=/^\d+$/.test(s),a=parseInt(s);if(E&&t&&a>=1&&a<=12){const e=g.getMockPayments(s,!1).map(e=>({id:e.id,description:e.description,amount:e.amount,currency:e.currency,splitCount:e.split_count,createdBy:e.created_by,createdAt:e.created_at,createdByName:"Demo User",isSettled:e.is_settled}));o(e)}else o([])}finally{f(!1)}};t.useEffect(()=>{V()},[s,E]);const Z=(e,t)=>new Intl.NumberFormat("en-US",{style:"currency",currency:t}).format(e);return u?e.jsx(a,{children:e.jsx(n,{className:"flex items-center justify-center py-8",children:e.jsx(k,{className:"w-6 h-6 animate-spin text-primary"})})}):e.jsxs(e.Fragment,{children:[e.jsxs(a,{className:"rounded-lg",children:[e.jsxs(r,{className:"py-3 px-4",children:[e.jsx(i,{className:"text-base",children:"Completed Payments"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Fully settled payment requests"})]}),e.jsx(n,{className:"py-3 px-4",children:l.length>0?e.jsx("div",{className:"space-y-1",children:l.map(t=>{const s=(null==q?void 0:q.id)===t.createdBy;return e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-border last:border-0 gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap flex-1 min-w-0",children:[e.jsx("span",{className:"font-semibold text-foreground",children:t.description}),e.jsx("span",{className:"text-muted-foreground hidden sm:inline",children:"•"}),t.isSettled?e.jsxs(T,{variant:"outline",className:"text-xs bg-emerald-500/10 text-emerald-300 border-emerald-500/30",children:[e.jsx(z,{className:"w-3 h-3 mr-1"}),"Settled"]}):e.jsxs(T,{variant:"outline",className:"text-xs bg-amber-500/10 text-amber-300 border-amber-500/30",children:[e.jsx(O,{className:"w-3 h-3 mr-1"}),"Pending"]}),e.jsx("span",{className:"text-muted-foreground hidden sm:inline",children:"•"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:t.createdByName||"Trip member"}),e.jsx("span",{className:"text-muted-foreground hidden sm:inline",children:"•"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Split ",t.splitCount," ways"]}),e.jsx("span",{className:"text-muted-foreground hidden sm:inline",children:"•"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:R(new Date(t.createdAt),"MMM d")})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx("span",{className:"font-bold text-foreground",children:Z(t.amount,t.currency)}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",Z(t.amount/t.splitCount,t.currency),"/ea)"]}),s&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(c,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:()=>(e=>{N(e),C(e.amount.toString()),U(e.description)})(t),children:e.jsx(Y,{className:"w-3.5 h-3.5"})}),e.jsx(c,{variant:"ghost",size:"icon",className:"h-7 w-7 text-destructive hover:text-destructive",onClick:()=>B(t.id),children:e.jsx(y,{className:"w-3.5 h-3.5"})})]})]})]},t.id)})}):e.jsx("p",{className:"text-center text-muted-foreground py-4",children:"No payments yet"})})]}),e.jsx(w,{open:!!b,onOpenChange:()=>N(null),children:e.jsxs(_,{children:[e.jsx(P,{children:e.jsx(S,{children:"Edit Payment"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"description",children:"Description"}),e.jsx(A,{id:"description",value:I,onChange:e=>U(e.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"amount",children:"Amount"}),e.jsx(A,{id:"amount",type:"number",step:"0.01",value:v,onChange:e=>C(e.target.value)})]})]}),e.jsxs(M,{children:[e.jsx(c,{variant:"outline",onClick:()=>N(null),children:"Cancel"}),e.jsx(c,{onClick:async()=>{if(!b)return;const e=/^\d+$/.test(s),t=parseInt(s);if(E&&e&&t>=1&&t<=12)return o(e=>e.map(e=>e.id===b.id?{...e,amount:parseFloat(v),description:I}:e)),L({title:"Payment updated (Demo)",description:"Changes saved"}),void N(null);await $.updatePaymentMessage(b.id,{amount:parseFloat(v),description:I})?(L({title:"Payment updated",description:"Changes saved"}),N(null),await V(),null==d||d()):L({title:"Error",description:"Failed to update payment",variant:"destructive"})},children:"Save Changes"})]})]})}),e.jsx(w,{open:!!D,onOpenChange:()=>B(null),children:e.jsxs(_,{children:[e.jsx(P,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(j,{className:"w-5 h-5 text-destructive"}),"Delete Payment"]})}),e.jsx("p",{className:"text-muted-foreground",children:"Are you sure you want to delete this payment request? This action cannot be undone."}),e.jsxs(M,{children:[e.jsx(c,{variant:"outline",onClick:()=>B(null),children:"Cancel"}),e.jsx(c,{variant:"destructive",onClick:()=>D&&(async e=>{const t=/^\d+$/.test(s),a=parseInt(s);if(E&&t&&a>=1&&a<=12)return o(t=>t.filter(t=>t.id!==e)),L({title:"Payment deleted (Demo)"}),void B(null);await $.deletePaymentMessage(e)?(L({title:"Payment deleted"}),B(null),await V(),null==d||d()):L({title:"Error",description:"Failed to delete payment",variant:"destructive"})})(D),children:"Delete"})]})]})})]})},ne={venmo:"Venmo",paypal:"PayPal",zelle:"Zelle",cashapp:"Cash App",applepay:"Apple Pay",applecash:"Apple Cash",cash:"Cash",other:"Other"},re=({tripId:d,onPaymentUpdated:l})=>{const[o,c]=t.useState([]),[u,y]=t.useState(!0),{isDemoMode:j}=x(),{user:f}=h(),{toast:w}=m(),_=/^\d+$/.test(d),P=parseInt(d,10),S=j&&_&&P>=1&&P<=12,C=async()=>{y(!0);try{const e=(await $.getTripPaymentMessages(d)).filter(e=>!e.isSettled);if(0===e.length)return c([]),void y(!1);const t=[...new Set(e.map(e=>e.createdBy))];if(S){const s=g.getMockMembers(d),a={};t.forEach(e=>{a[e]=[{method:"venmo",displayName:"Venmo",identifier:"@demo-user"},{method:"paypal",displayName:"PayPal",identifier:"demo@email.com"},{method:"zelle",displayName:"Zelle",identifier:"555-123-4567"},{method:"cashapp",displayName:"Cash App",identifier:"$demouser"}]});const n=e.map(e=>{const t=e.splitParticipants.map((t,a)=>{const n=s.find(e=>e.user_id===t);return{id:`demo-split-${e.id}-${a}`,debtor_user_id:t,amount_owed:e.amount/e.splitCount,is_settled:!1,settled_at:null,debtor_name:(null==n?void 0:n.display_name)||`Participant ${a+1}`,debtor_avatar:null==n?void 0:n.avatar_url}}),n=a[e.createdBy]||[],r=e.paymentMethods||[],i=n.filter(e=>r.includes(e.method));return{...e,splits:t,settledCount:0,creatorPaymentDetails:i}});return c(n),void y(!1)}const s=e.map(e=>e.id),[a,n]=await Promise.all([p.from("payment_splits").select("*").in("payment_message_id",s),p.from("user_payment_methods").select("user_id, method_type, identifier, display_name").in("user_id",t)]);if(a.error)throw a.error;const r=new Map;(n.data||[]).forEach(e=>{var t,s;const a=r.get(e.user_id)||[];a.push({method:(null==(t=e.method_type)?void 0:t.toLowerCase())||"other",displayName:e.display_name||ne[(null==(s=e.method_type)?void 0:s.toLowerCase())||"other"]||e.method_type||"Other",identifier:e.identifier||""}),r.set(e.user_id,a)});const i=[...new Set((a.data||[]).map(e=>e.debtor_user_id))],{data:l}=await p.from("profiles").select("user_id, display_name, avatar_url").in("user_id",i),o=new Map((null==l?void 0:l.map(e=>[e.user_id,e]))||[]),m=e.map(e=>{const t=(a.data||[]).filter(t=>t.payment_message_id===e.id).map(e=>{const t=o.get(e.debtor_user_id);return{id:e.id,debtor_user_id:e.debtor_user_id,amount_owed:parseFloat(e.amount_owed.toString()),is_settled:e.is_settled,settled_at:e.settled_at,debtor_name:(null==t?void 0:t.display_name)||"Unknown",debtor_avatar:null==t?void 0:t.avatar_url}}),s=r.get(e.createdBy)||[],n=(e.paymentMethods||[]).map(e=>e.toLowerCase()),i=n.length>0?s.filter(e=>n.includes(e.method)):s;return{...e,splits:t,settledCount:t.filter(e=>e.is_settled).length,creatorPaymentDetails:i}});c(m)}catch(e){c([])}finally{y(!1)}};t.useEffect(()=>{C()},[d,j]);const M=(e,t)=>new Intl.NumberFormat("en-US",{style:"currency",currency:t}).format(e);return u?e.jsx(a,{children:e.jsx(n,{className:"flex items-center justify-center py-6",children:e.jsx(k,{className:"w-5 h-5 animate-spin text-primary"})})}):0===o.length?null:e.jsxs(a,{className:"rounded-lg border-amber-500/30 bg-gradient-to-br from-amber-900/10 to-amber-950/10",children:[e.jsxs(r,{className:"py-3 px-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-4 h-4 text-amber-400"}),e.jsx(i,{className:"text-base text-amber-100",children:"Outstanding Payments"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Track who has paid and mark as settled"})]}),e.jsx(n,{className:"py-2 px-4 space-y-3",children:o.map(t=>{const a=(null==f?void 0:f.id)===t.createdBy;return e.jsxs("div",{className:"bg-card/50 rounded-lg p-3 border border-border",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap flex-1 min-w-0",children:[e.jsx("span",{className:"font-semibold text-base text-foreground",children:t.description}),e.jsx("span",{className:"text-muted-foreground hidden sm:inline",children:"•"}),e.jsxs(T,{variant:"outline",className:"text-xs bg-amber-500/10 text-amber-300 border-amber-500/30",children:[e.jsx(O,{className:"w-3 h-3 mr-1"}),"Pending"]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[t.settledCount,"/",t.splits.length," paid"]}),t.creatorPaymentDetails.map(t=>e.jsxs(s.Fragment,{children:[e.jsx("span",{className:"text-muted-foreground hidden sm:inline",children:"•"}),e.jsxs("span",{className:"text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[t.displayName,":"]})," ",e.jsx("span",{className:"text-primary",children:t.identifier||"—"})]})]},t.method))]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx("span",{className:"font-bold text-lg text-foreground",children:M(t.amount,t.currency)}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",M(t.amount/t.splitCount,t.currency),"/ea)"]})]})]}),a&&t.splits.length>0&&e.jsx("div",{className:"mt-2 pt-2 border-t border-border space-y-0.5",children:t.splits.map(s=>{var a;return e.jsxs("div",{className:"flex items-center justify-between py-0.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{checked:s.is_settled,onCheckedChange:()=>(async(e,t,s)=>{if(S)return c(a=>a.map(a=>{if(a.id===t){const t=a.splits.map(t=>t.id===e?{...t,is_settled:!s,settled_at:s?null:(new Date).toISOString()}:t),n=t.filter(e=>e.is_settled).length,r=n===t.length;return{...a,splits:t,settledCount:n,isSettled:r}}return a}).filter(e=>!e.isSettled)),void w({title:s?"Marked as unpaid":"Marked as paid",description:"Payment status updated"});let a;a=s?await $.unsettlePayment(e):await $.settlePayment(e,"manual"),a?(w({title:s?"Marked as unpaid":"Marked as paid",description:"Payment status updated"}),await C(),null==l||l()):w({title:"Error",description:"Failed to update payment status",variant:"destructive"})})(s.id,t.id,s.is_settled)}),e.jsxs(b,{className:"w-5 h-5",children:[e.jsx(N,{src:s.debtor_avatar}),e.jsx(v,{className:"text-xs",children:(null==(a=s.debtor_name)?void 0:a.charAt(0))||"?"})]}),e.jsx("span",{className:"text-sm "+(s.is_settled?"text-muted-foreground":"text-foreground"),children:s.debtor_name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:M(s.amount_owed,t.currency)}),s.is_settled&&e.jsx(T,{variant:"outline",className:"text-xs bg-emerald-500/10 text-emerald-300 border-emerald-500/30",children:"Paid"})]})]},s.id)})}),!a&&e.jsxs("div",{className:"flex items-center gap-1 mt-1 text-xs text-muted-foreground",children:[e.jsx(Z,{className:"w-3 h-3"}),e.jsxs("span",{children:["Split among ",t.splitCount," people"]})]})]},t.id)})})]})},ie=({tripId:s})=>{const{user:r}=h(),{createPaymentMessage:i}=(e=>{const[s,a]=t.useState([]),[n,r]=t.useState([]),[i,d]=t.useState(!1),{user:l}=h(),{isDemoMode:o}=x(),m=null==l?void 0:l.id;return t.useEffect(()=>{m&&(async()=>{d(!0);try{const e=await $.getUserPaymentMethods(m);a(e)}catch(e){}finally{d(!1)}})()},[m]),t.useEffect(()=>{e&&(async()=>{d(!0);try{const t=await $.getTripPaymentMessages(e);r(t)}catch(t){}finally{d(!1)}})()},[e]),t.useEffect(()=>{if(!e||o)return;const t=p.channel(`trip_payments:${e}`).on("postgres_changes",{event:"*",schema:"public",table:"trip_payment_messages",filter:`trip_id=eq.${e}`},async t=>{try{const t=await $.getTripPaymentMessages(e);r(t)}catch(s){}}).on("postgres_changes",{event:"*",schema:"public",table:"payment_splits"},async t=>{try{const t=await $.getTripPaymentMessages(e);r(t)}catch(s){}}).subscribe();return()=>{p.removeChannel(t)}},[e,o]),{paymentMethods:s,tripPayments:n,loading:i,addPaymentMethod:async e=>{if(!m)return!1;const t=await $.savePaymentMethod(m,e);if(t){const e=await $.getUserPaymentMethods(m);a(e)}return t},updatePaymentMethod:async(e,t)=>{const s=await $.updatePaymentMethod(e,t);if(s&&m){const e=await $.getUserPaymentMethods(m);a(e)}return s},deletePaymentMethod:async e=>{const t=await $.deletePaymentMethod(e);if(t&&m){const e=await $.getUserPaymentMethods(m);a(e)}return t},createPaymentMessage:async t=>{if(!e||!m)return null;const s=await $.createPaymentMessage(e,m,t);if(s){const t=await $.getTripPaymentMessages(e);r(t)}return s},settlePayment:async(t,s)=>{const a=await $.settlePayment(t,s);if(a&&e){const t=await $.getTripPaymentMessages(e);r(t)}return a},getTripPaymentSummary:async()=>e?await $.getTripPaymentSummary(e):null}})(s),{toast:d}=m(),{isDemoMode:l,isLoading:o}=x(),{tier:u,isLoading:y,upgradeToTier:j}=f(),{isSuperAdmin:b}=H(),[N,v]=t.useState(null),[w,_]=t.useState(0),[P,S]=t.useState(!0),[C,M]=t.useState([]),[I,O]=t.useState([]),[U,D]=t.useState(!0),[B,T]=t.useState(!1),A=/^\d+$/.test(s),F=parseInt(s,10),Y=A&&!isNaN(F)&&F>=1&&F<=12,R=l&&Y;t.useEffect(()=>{(async()=>{var e;if(s){D(!0);try{if(R){const e=J(F);if(e&&e.participants){const t=e.participants.map(e=>({id:String(e.id),name:e.name,avatar:e.avatar}));M(t)}else{const e=g.getMockMembers(s);M(e.map(e=>({id:e.user_id,name:e.display_name,avatar:e.avatar_url})))}const t=g.getMockPayments(s,!1);return O(t),void D(!1)}const[t,a]=await Promise.all([Q.getTripMembers(s),$.getTripPaymentMessages(s)]),n=t.map(e=>{var t,s,a,n;return{id:e.user_id,name:(null==(t=e.profiles)?void 0:t.display_name)||(null==(a=null==(s=e.profiles)?void 0:s.email)?void 0:a.split("@")[0])||"Unknown User",avatar:(null==(n=e.profiles)?void 0:n.avatar_url)||void 0}});let i=n;if(r&&!n.find(e=>e.id===r.id)){const{data:t}=await p.from("profiles").select("display_name, avatar_url").eq("user_id",r.id).single();i=[{id:r.id,name:(null==t?void 0:t.display_name)||(null==(e=r.email)?void 0:e.split("@")[0])||"Unknown",avatar:null==t?void 0:t.avatar_url},...n]}M(i),O(a)}catch(t){d({title:"Error",description:"Failed to load payment information",variant:"destructive"})}finally{D(!1)}}})()},[s,r,R]),t.useEffect(()=>{if(!s||R)return;const e=p.channel(`payments-profiles-${s}`).on("postgres_changes",{event:"*",schema:"public",table:"profiles"},e=>{const t=e.new,s=null==t?void 0:t.user_id;s&&M(e=>e.map(e=>e.id===s?{...e,name:t.display_name??e.name,avatar:t.avatar_url??e.avatar}:e))}).subscribe();return()=>{p.removeChannel(e).catch(()=>{})}},[s,R]);const V=t.useMemo(()=>I.filter(e=>e.createdBy===(null==r?void 0:r.id)).length,[I,r]),Z=b?-1:"free"===u?5:-1,X=-1===Z?-1:Math.max(0,Z-V),ee=b||-1===Z||V<Z,te=t.useMemo(()=>{if(!r||0===I.length)return{totalPaid:0,totalOwed:0,totalOwedToYou:0,totalYouOwe:0,isSettled:!0};let e=0,t=0,s=0,a=0;I.forEach(t=>{t.createdBy===r.id?(e+=t.amount,t.isSettled||(s+=t.amount/t.splitCount*(t.splitCount-1))):t.isSettled||(a+=t.amount/t.splitCount)}),t=s+a;return{totalPaid:e,totalOwed:t,totalOwedToYou:s,totalYouOwe:a,isSettled:0===t}},[I,r]);t.useEffect(()=>{if(o)return;(async()=>{if(R){const e=g.getMockPayments(s,!1),t=g.getMockMembers(s),a=e.reduce((e,t)=>e+t.amount,0)/Math.max(t.length,1);return v({totalOwed:.6*a,totalOwedToYou:.4*a,netBalance:.2*a,baseCurrency:"USD",balances:t.slice(0,3).map((e,t)=>({userId:e.user_id,userName:e.display_name,avatar:e.avatar_url,amountOwed:(0===t?.5*a:.3*a)*(t%2==0?1:-1),amountOwedCurrency:"USD",preferredPaymentMethod:null,unsettledPayments:[]}))}),void S(!1)}if(!(null==r?void 0:r.id))return v({totalOwed:0,totalOwedToYou:0,netBalance:0,baseCurrency:"USD",balances:[]}),void S(!1);S(!0);try{const e=await L.getBalanceSummary(s,r.id);v(e)}catch(e){e instanceof Error&&e.message.includes("Unauthorized")?d({title:"Access Denied",description:"You don't have permission to view payment balances for this trip.",variant:"destructive"}):d({title:"Error",description:"Failed to load payment balances.",variant:"destructive"}),v({totalOwed:0,totalOwedToYou:0,netBalance:0,baseCurrency:"USD",balances:[]})}finally{S(!1)}})()},[s,null==r?void 0:r.id,R,o]);const ne=t.useCallback(()=>{_(e=>e+1)},[]);return P?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(k,{className:"w-8 h-8 animate-spin text-primary"})}):N?e.jsxs("div",{className:"space-y-3",children:[te.isSettled&&I.length>0&&e.jsx(a,{className:"bg-gradient-to-br from-emerald-900/20 to-emerald-950/20 border-emerald-500/20",children:e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-emerald-400",children:[e.jsx(z,{size:20}),e.jsx("span",{className:"text-sm font-medium",children:"All settled up! No outstanding payments."})]})})}),o||y?e.jsx("div",{className:"flex items-center justify-center py-6 opacity-80",children:e.jsx(k,{className:"w-5 h-5 animate-spin text-muted-foreground"})}):r||R?U?e.jsxs("div",{className:"flex items-center justify-center py-6 opacity-80",children:[e.jsx(k,{className:"w-5 h-5 animate-spin text-muted-foreground"}),e.jsx("span",{className:"ml-2 text-sm text-muted-foreground",children:"Loading trip members..."})]}):ee||"free"!==u||b?e.jsxs(e.Fragment,{children:["free"===u&&!b&&X>0&&-1!==X&&e.jsxs("div",{className:"flex items-center justify-between bg-blue-900/20 border border-blue-500/30 rounded-lg px-4 py-2 mb-2",children:[e.jsxs("span",{className:"text-sm text-blue-300",children:[X," of 5 payment requests remaining"]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>window.location.href="/settings?tab=subscription",className:"text-blue-400 hover:text-blue-300 h-auto py-1",children:"Upgrade"})]}),e.jsx(q,{onSubmit:async e=>{if(R){const t=g.addSessionPayment(s,e);if(t){ne();const a=[...g.getMockPayments(s,!1),...g.getSessionPayments(s)],n=g.getMockMembers(s),r=a.reduce((e,t)=>e+t.amount,0)/Math.max(n.length,1);v({totalOwed:.6*r,totalOwedToYou:.4*r,netBalance:.2*r,baseCurrency:"USD",balances:n.slice(0,3).map((e,t)=>({userId:e.user_id,userName:e.display_name,avatar:e.avatar_url,amountOwed:(0===t?.5*r:.3*r)*(t%2==0?1:-1),amountOwedCurrency:"USD",preferredPaymentMethod:null,unsettledPayments:[]}))});const i={id:t,trip_id:s,amount:e.amount,currency:e.currency,description:e.description,split_count:e.splitCount,split_participants:e.splitParticipants,payment_methods:e.paymentMethods,created_by:"demo-user",is_settled:!1,created_at:(new Date).toISOString()};O(e=>[i,...e])}return}const t=await i(e);if(t){ne();const n={id:t,tripId:s,amount:e.amount,currency:e.currency,description:e.description,splitCount:e.splitCount,splitParticipants:e.splitParticipants,paymentMethods:e.paymentMethods,createdBy:(null==r?void 0:r.id)||"",createdAt:(new Date).toISOString(),isSettled:!1};if(O(e=>[n,...e]),null==r?void 0:r.id)try{const e=await L.getBalanceSummary(s,r.id);v(e)}catch(a){}}else d({title:"Error",description:"Failed to create payment request",variant:"destructive"})},tripMembers:C,isVisible:!0,tripId:s})]}):e.jsx(a,{className:"bg-gradient-to-br from-amber-900/20 to-amber-950/20 border-amber-500/30",children:e.jsxs(n,{className:"p-6 text-center",children:[e.jsx(K,{className:"w-12 h-12 text-amber-400 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Payment Limit Reached"}),e.jsx("p",{className:"text-gray-400 text-sm mb-4",children:"You've created 5 payment requests for this trip (free tier limit)."}),e.jsx(c,{onClick:()=>j("explorer","monthly"),className:"bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700",children:"Upgrade for Unlimited Payments - $9.99/mo"})]})}):e.jsxs("div",{className:"bg-card rounded-lg border border-border p-4 text-center",children:[e.jsx(E,{className:"w-10 h-10 mx-auto mb-3 text-muted-foreground"}),e.jsx("h3",{className:"text-base font-semibold mb-2",children:"Sign in to create payment requests"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"You need to be signed in to create and manage payments for this trip."}),e.jsx(c,{variant:"default",onClick:()=>T(!0),children:"Sign In"})]}),e.jsx(G,{summary:N}),N.balances.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-base font-semibold text-foreground mb-1",children:"Balance Breakdown"}),N.balances.map(t=>e.jsx(se,{balance:t,tripId:s},t.userId))]}):e.jsx("div",{className:"text-center py-4 bg-muted/50 rounded-lg border border-border",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"All settled up! No outstanding payments."})}),e.jsx(re,{tripId:s,onPaymentUpdated:ne},`outstanding-${w}`),e.jsx(ae,{tripId:s,onPaymentUpdated:ne},`history-${w}`),e.jsx(W,{isOpen:B,onClose:()=>T(!1)})]}):e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"Unable to load payment information"})};export{ie as PaymentsTab};
