import{A as C,u as I,k as T,r as c,s as v,j as e,t as m}from"./index-CAsyng-G.js";import{L as j}from"./loader-circle-CkOmKk2l.js";import{U as E}from"./users-DV9oPzUN.js";import{M as q}from"./map-pin-BpJQ3jXK.js";import{C as w}from"./calendar-B2WMmvpa.js";import{C as A}from"./clock-z7hIZNmF.js";const D=()=>{const{token:a}=C(),o=I(),{user:h}=T(),[y,l]=c.useState(!0),[p,u]=c.useState(!1),[s,f]=c.useState(null),[b,d]=c.useState(""),[S,N]=c.useState(!1);c.useEffect(()=>{document.title="Join Trip - Chravel";const t=(n,x)=>{let i=document.querySelector(`meta[property="${n}"]`);i||(i=document.createElement("meta"),i.setAttribute("property",n),document.head.appendChild(i)),i.content=x},r=(n,x)=>{let i=document.querySelector(`meta[name="${n}"]`);i||(i=document.createElement("meta"),i.setAttribute("name",n),document.head.appendChild(i)),i.content=x};t("og:title","Join an Amazing Trip!"),t("og:description","You've been invited to join a trip. Click to see details and join the adventure!"),t("og:type","website"),t("og:image","https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=1200&h=630&fit=crop"),r("twitter:card","summary_large_image"),r("twitter:title","Join an Amazing Trip!"),r("twitter:description","You've been invited to join a trip. Click to see details and join the adventure!"),r("twitter:image","https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=1200&h=630&fit=crop")},[]),c.useEffect(()=>{a?_():(d("Invalid invite link"),l(!1))},[a]);const _=async()=>{if(!a)return;const t=`chravel://join-trip/${a}`;if(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){const r=Date.now();window.location.href=t,setTimeout(()=>{Date.now()-r<2e3&&g()},1500)}else g()},g=async()=>{if(a)try{const{data:t,error:r}=await v.from("trip_invites").select("*").eq("code",a).single();if(r||!t){console.error("Error fetching invite:",r),d("Invalid invite link"),l(!1);return}if(!t.is_active){d("This invite link has been deactivated"),l(!1);return}if(t.expires_at&&new Date(t.expires_at)<new Date){d("This invite link has expired"),l(!1);return}if(t.max_uses&&t.current_uses>=t.max_uses){d("This invite link has reached its maximum number of uses"),l(!1);return}N(!1),f({trip_id:t.trip_id,invite_token:a,created_at:t.created_at,require_approval:!1,expires_at:t.expires_at,max_uses:t.max_uses,current_uses:t.current_uses,is_active:t.is_active,code:t.code,id:t.id,created_by:t.created_by}),l(!1)}catch(t){console.error("Error fetching invite data:",t),d("Failed to load invite details"),l(!1)}},k=async()=>{if(!h){m.error("Please log in to join this trip");return}if(!(!a||!s)){u(!0);try{const{data:t,error:r}=await v.functions.invoke("join-trip",{body:{inviteCode:a}});if(r){console.error("Error joining trip:",r),m.error(r.message||"Failed to join trip"),u(!1);return}if(!t.success){m.error(t.message||"Failed to join trip"),u(!1);return}if(t.requires_approval){m.success(t.message||"Join request submitted!"),u(!1),f(n=>n?{...n,require_approval:!0}:null);return}m.success(t.message||"Successfully joined the trip!"),setTimeout(()=>{t.trip_type==="pro"?o(`/tour/pro/${t.trip_id}`):t.trip_type==="event"?o(`/event/${t.trip_id}`):o(`/trip/${t.trip_id}`)},1e3)}catch(t){console.error("Error joining trip:",t),m.error("An unexpected error occurred. Please try again.")}finally{u(!1)}}};return y?e.jsx("div",{className:"min-h-screen bg-black flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(j,{className:"h-8 w-8 animate-spin text-white mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Loading invite details..."})]})}):b?e.jsx("div",{className:"min-h-screen bg-black flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("h1",{className:"text-2xl font-bold text-white mb-4",children:"Invalid Invite"}),e.jsx("p",{className:"text-gray-400 mb-6",children:b}),e.jsx("button",{onClick:()=>o("/"),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition-colors",children:"Go to Dashboard"})]})}):e.jsx("div",{className:"min-h-screen bg-black flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white/10 backdrop-blur-md border border-white/20 rounded-3xl p-8 max-w-md w-full",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(E,{className:"h-8 w-8 text-white"})}),e.jsx("h1",{className:"text-2xl font-bold text-white mb-2",children:"You're Invited!"}),e.jsx("p",{className:"text-gray-400",children:"Join this amazing trip with your friends"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-yellow-600/20 via-yellow-500/10 to-transparent border border-yellow-500/20 rounded-2xl p-4 mb-6 relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-[url('https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=400&h=200&fit=crop')] bg-cover bg-center opacity-10 rounded-2xl"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-3",children:"Trip Invitation"}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-300",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{size:16,className:"text-yellow-400"}),e.jsxs("span",{children:["Trip ID: ",s==null?void 0:s.trip_id]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{size:16,className:"text-yellow-400"}),e.jsxs("span",{children:["Invited ",s!=null&&s.created_at?new Date(s.created_at).toLocaleDateString():"Recently"]})]}),(s==null?void 0:s.expires_at)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{size:16,className:"text-yellow-400"}),e.jsxs("span",{children:["Expires: ",new Date(s.expires_at).toLocaleDateString()]})]}),(s==null?void 0:s.max_uses)&&e.jsx("div",{className:"flex items-center gap-2 text-gray-400 text-xs",children:e.jsxs("span",{children:["Uses: ",s.current_uses||0," / ",s.max_uses]})})]})]})]}),h?e.jsxs("div",{className:"space-y-4",children:[e.jsx("button",{onClick:k,disabled:p,className:"w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white py-4 px-6 rounded-xl transition-all duration-200 font-medium disabled:opacity-50 flex items-center justify-center gap-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"h-4 w-4 animate-spin"}),"Joining..."]}):"Join Trip"}),e.jsx("button",{onClick:()=>o("/"),className:"w-full bg-white/10 hover:bg-white/20 border border-white/20 text-white py-3 px-6 rounded-xl transition-colors",children:"Go to Dashboard"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-gray-300 text-center",children:"Please log in to join this trip"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>o("/login"),className:"w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white py-3 px-6 rounded-xl transition-all duration-200 font-medium",children:"Log In"}),e.jsx("button",{onClick:()=>o("/signup"),className:"w-full bg-white/10 hover:bg-white/20 border border-white/20 text-white py-3 px-6 rounded-xl transition-colors",children:"Sign Up"})]})]}),(s==null?void 0:s.require_approval)&&!p&&e.jsxs("div",{className:"mt-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(A,{className:"h-5 w-5 text-yellow-400"}),e.jsx("p",{className:"font-medium text-yellow-400",children:"Approval Required"})]}),e.jsx("p",{className:"text-yellow-400/80 text-sm",children:"This trip requires approval from the organizer. Your request will be reviewed once submitted."})]})]})})};export{D as default};
