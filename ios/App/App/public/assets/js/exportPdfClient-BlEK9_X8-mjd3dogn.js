import{E as t,a as e}from"./pdf-G87Ow8VM-mjd3dogn.js";import"./supabase-DyX-XggK-mjd3dogn.js";import"./react-vendor-D1R0t5S0-mjd3dogn.js";function o(t,e){const o=t.lastAutoTable,n=null==o?void 0:o.finalY;return"number"==typeof n&&isFinite(n)?n:e}async function n(t,e=5e3){const o=new AbortController,n=setTimeout(()=>o.abort(),e);try{const e=await fetch(t,{signal:o.signal});if(clearTimeout(n),!e.ok)throw new Error(`Font fetch failed: ${e.status}`);const s=await e.blob();return new Promise((t,e)=>{const o=new FileReader;o.onloadend=()=>{"string"==typeof o.result?t(o.result.split(",")[1]):e(new Error("Failed to read font as base64."))},o.onerror=()=>{e(new Error("Error reading font file."))},o.readAsDataURL(s)})}catch(s){throw clearTimeout(n),s}}function s(t,e){const o=[];for(let n=0;n<t.length;n+=e)o.push(t.slice(n,n+e));return o}function a(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]:[66,139,202]}async function l(l,r,d){var c,g,h;const{customization:S,onProgress:f}=d||{},m=Math.max(1,Math.floor((null==S?void 0:S.maxItemsPerSection)||100)),F=(null==S?void 0:S.primaryColor)||"#428BCA",p=(null==S?void 0:S.secondaryColor)||"#5BC0DE",[x,u,N]=a(F);a(p);const z=(t,e,o,n)=>{null==f||f({stage:t,current:e,total:o,message:n})};z("preparing",0,r.length+2,"Initializing PDF...");const C=new t({orientation:"portrait",unit:"pt",format:"letter",compress:!1!==(null==S?void 0:S.compress)});await async function(t){try{const[e,o,s,a]=await Promise.all([n("https://cdn.jsdelivr.net/fontsource/fonts/noto-sans@latest/latin-400-normal.ttf"),n("https://cdn.jsdelivr.net/fontsource/fonts/noto-sans@latest/latin-700-normal.ttf"),n("https://cdn.jsdelivr.net/fontsource/fonts/noto-sans@latest/latin-400-italic.ttf"),n("https://cdn.jsdelivr.net/fontsource/fonts/noto-sans@latest/latin-700-italic.ttf")]);t.addFileToVFS("NotoSans-Regular.ttf",e),t.addFileToVFS("NotoSans-Bold.ttf",o),t.addFileToVFS("NotoSans-Italic.ttf",s),t.addFileToVFS("NotoSans-BoldItalic.ttf",a),t.addFont("NotoSans-Regular.ttf","NotoSans","normal"),t.addFont("NotoSans-Bold.ttf","NotoSans","bold"),t.addFont("NotoSans-Italic.ttf","NotoSans","italic"),t.addFont("NotoSans-BoldItalic.ttf","NotoSans","bolditalic"),t.setFont("NotoSans","normal")}catch(e){t.setFont("helvetica","normal")}}(C);const T=C.internal.pageSize.getWidth(),b=C.internal.pageSize.getHeight(),y=40,v=T-80;let $=y;if(C.setFontSize(24),C.setFont("NotoSans","bold"),C.text(l.tripTitle,y,$),$+=30,l.destination&&(C.setFontSize(12),C.setFont("NotoSans","normal"),C.text(l.destination,y,$),$+=20),l.dateRange&&(C.setFontSize(11),C.setTextColor(100),C.text(l.dateRange,y,$),$+=20),l.description){C.setFontSize(10),C.setTextColor(80);const t=C.splitTextToSize(l.description,v);C.text(t,y,$),$+=14*t.length+10}C.setDrawColor(200),C.line(y,$,T-y,$),$+=30;const w=((null==S?void 0:S.sectionOrder)||r).filter(t=>r.includes(t));C.setFontSize(14),C.setFont("NotoSans","bold"),C.setTextColor(0);let P=0;for(const t of w){if(P++,z("rendering",P,w.length+2,`Rendering ${t}...`),"calendar"===t){$=i(C,$,60);const t=l.calendar||[];if(t.length>0){const n=t.length>m?s(t,m):[t];for(let s=0;s<n.length;s++){const a=n[s];$=i(C,$,60),0===s&&(C.setFontSize(14),C.setFont("NotoSans","bold"),C.setTextColor(0),C.text("Calendar",y,$),$+=20);const l=a.map(t=>[t.title||"Untitled Event",t.start_time?new Date(t.start_time).toLocaleString():"N/A",t.location||"N/A",t.description?t.description.substring(0,50)+"...":""]);e(C,{startY:$,head:[["Event","Date & Time","Location","Description"]],body:l,theme:"striped",headStyles:{fillColor:[x,u,N],fontSize:10},margin:{left:y,right:y},styles:{fontSize:9}}),$=o(C,$)+10,s<n.length-1&&($=i(C,$,30),C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(120),C.text(`(Continued on next page - showing ${(s+1)*m} of ${t.length} events)`,y,$),$+=20,C.addPage(),$=y)}}else C.setFontSize(10),C.setFont("NotoSans","normal"),C.setTextColor(120),C.text("No calendar events available",y,$),$+=30}if("payments"===t){$=i(C,$,60);const t=(null==(c=l.payments)?void 0:c.items)||[];if(t.length>0){const n=t.length>m?s(t,m):[t];for(let s=0;s<n.length;s++){const a=n[s];$=i(C,$,60),0===s&&(C.setFontSize(14),C.setFont("NotoSans","bold"),C.setTextColor(0),C.text("Payments",y,$),$+=20);const r=a.map(t=>{var e;return[t.description||"N/A",`${t.currency||"USD"} ${(null==(e=t.amount)?void 0:e.toFixed(2))||"0.00"}`,`${t.split_count||0} people`,t.is_settled?"Settled":"Pending"]});e(C,{startY:$,head:[["Description","Amount","Split","Status"]],body:r,theme:"striped",headStyles:{fillColor:[x,u,N],fontSize:10},margin:{left:y,right:y},styles:{fontSize:9}}),$=o(C,$)+10,s===n.length-1&&(C.setFontSize(10),C.setFont("NotoSans","bold"),C.text(`Total: ${(null==(g=l.payments)?void 0:g.currency)||"USD"} ${((null==(h=l.payments)?void 0:h.total)||0).toFixed(2)}`,y,$),$+=30),s<n.length-1&&($=i(C,$,30),C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(120),C.text(`(Continued - showing ${(s+1)*m} of ${t.length} payments)`,y,$),$+=20,C.addPage(),$=y)}}else C.setFontSize(10),C.setFont("NotoSans","normal"),C.setTextColor(120),C.text("No payment records available",y,$),$+=30}if("polls"===t){$=i(C,$,60);const t=l.polls||[];if(t.length>0){const n=t.length>m?s(t,m):[t];for(let s=0;s<n.length;s++){const a=n[s];$=i(C,$,60),0===s&&(C.setFontSize(14),C.setFont("NotoSans","bold"),C.setTextColor(0),C.text("Polls",y,$),$+=20),a.forEach((t,n)=>{$=i(C,$,80),C.setFontSize(11),C.setFont("NotoSans","bold"),C.setTextColor(0);const a=s*m+n+1;if(C.text(`${a}. ${t.question}`,y,$),$+=15,t.options&&t.options.length>0){const n=t.options.map(e=>{const o=t.total_votes>0?(e.votes/t.total_votes*100).toFixed(1):"0.0";return[e.text||"N/A",`${e.votes||0} votes`,`${o}%`]});e(C,{startY:$,body:n,theme:"plain",margin:{left:60,right:y},styles:{fontSize:9,cellPadding:3}}),$=o(C,$)+5}C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(100);const l=Math.max(0,Number(t.total_votes||0));C.text(`Total votes: ${l}`,60,$),$+=20}),s<n.length-1&&($=i(C,$,30),C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(120),C.text(`(Continued - showing ${(s+1)*m} of ${t.length} polls)`,y,$),$+=20,C.addPage(),$=y)}}else C.setFontSize(10),C.setFont("NotoSans","normal"),C.setTextColor(120),C.text("No polls available",y,$),$+=30}if("places"===t){$=i(C,$,60);const t=l.places||[];if(t.length>0){const n=t.length>m?s(t,m):[t];for(let s=0;s<n.length;s++){const a=n[s];$=i(C,$,60),0===s&&(C.setFontSize(14),C.setFont("NotoSans","bold"),C.setTextColor(0),C.text("Places & Links",y,$),$+=20);const l=(t,e=45)=>{if(!t||t.length<=e)return t;try{const e=new URL(t),o=e.hostname.replace("www.",""),n=e.pathname.slice(0,15);return`${o}${n}${n.length<e.pathname.length?"...":""}`}catch{return t.slice(0,e)+"..."}},r=a.map(t=>{var e;return[t.name||"N/A",l(t.url||"N/A"),(null==(e=t.votes)?void 0:e.toString())||"0"]});e(C,{startY:$,head:[["Name","URL","Votes"]],body:r,theme:"striped",headStyles:{fillColor:[x,u,N],fontSize:10},margin:{left:y,right:y},styles:{fontSize:9,cellPadding:4,overflow:"linebreak"},columnStyles:{0:{cellWidth:.4*v},1:{cellWidth:.48*v},2:{cellWidth:.12*v,halign:"center"}}}),$=o(C,$)+10,s<n.length-1&&($=i(C,$,30),C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(120),C.text(`(Continued - showing ${(s+1)*m} of ${t.length} places)`,y,$),$+=20,C.addPage(),$=y)}}else C.setFontSize(10),C.setFont("NotoSans","normal"),C.setTextColor(120),C.text("No places saved",y,$),$+=30}if("tasks"===t){$=i(C,$,60);const t=l.tasks||[];if(t.length>0){const n=t.length>m?s(t,m):[t];for(let s=0;s<n.length;s++){const a=n[s];$=i(C,$,60),0===s&&(C.setFontSize(14),C.setFont("NotoSans","bold"),C.setTextColor(0),C.text("Tasks",y,$),$+=20);const l=a.map(t=>[t.title||t.description||"N/A",t.completed?"[x] Done":"[ ] Pending"]);e(C,{startY:$,head:[["Task","Status"]],body:l,theme:"striped",headStyles:{fillColor:[x,u,N],fontSize:10},margin:{left:y,right:y},styles:{fontSize:9}}),$=o(C,$)+10,s<n.length-1&&($=i(C,$,30),C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(120),C.text(`(Continued - showing ${(s+1)*m} of ${t.length} tasks)`,y,$),$+=20,C.addPage(),$=y)}}else C.setFontSize(10),C.setFont("NotoSans","normal"),C.setTextColor(120),C.text("No tasks available",y,$),$+=30}if("broadcasts"===t){$=i(C,$,60);const t=l.broadcasts||[];if(t.length>0){const e=t.length>m?s(t,m):[t];for(let o=0;o<e.length;o++){const n=e[o];$=i(C,$,60),0===o&&(C.setFontSize(14),C.setFont("NotoSans","bold"),C.setTextColor(0),C.text("Broadcasts",y,$),$+=20),n.forEach((t,e)=>{$=i(C,$,80);const o="urgent"===t.priority?[220,38,38]:[100,100,100];C.setTextColor(o[0],o[1],o[2]),C.setFontSize(9),C.setFont("NotoSans","bold"),C.text(t.priority.toUpperCase(),y,$),C.setTextColor(100),C.setFont("NotoSans","normal");const n=new Date(t.timestamp).toLocaleString();C.text(`  •  ${n}`,90,$),$+=15,C.setFontSize(10),C.setFont("NotoSans","normal"),C.setTextColor(0);const s=C.splitTextToSize(t.message,v-20);C.text(s,50,$),$+=14*s.length+5,C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(120),C.text(`Sent by: ${t.sender}  •  ${t.read_count} read`,50,$),$+=20}),o<e.length-1&&($=i(C,$,30),C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(120),C.text(`(Continued - showing ${(o+1)*m} of ${t.length} broadcasts)`,y,$),$+=20,C.addPage(),$=y)}}else C.setFontSize(10),C.setFont("NotoSans","normal"),C.setTextColor(120),C.text("No broadcasts available",y,$),$+=30}if("roster"===t){$=i(C,$,60);const t=l.roster||[];if(t.length>0){const n=t.length>m?s(t,m):[t];for(let s=0;s<n.length;s++){const a=n[s];$=i(C,$,60),0===s&&(C.setFontSize(14),C.setFont("NotoSans","bold"),C.setTextColor(0),C.text("Roster & Contacts",y,$),$+=20);const l=a.map(t=>[t.name||"N/A",t.email||"Not shared",t.role||"member"]);e(C,{startY:$,head:[["Name","Email","Role"]],body:l,theme:"striped",headStyles:{fillColor:[x,u,N],fontSize:10},margin:{left:y,right:y},styles:{fontSize:9}}),$=o(C,$)+10,s<n.length-1&&($=i(C,$,30),C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(120),C.text(`(Continued - showing ${(s+1)*m} of ${t.length} members)`,y,$),$+=20,C.addPage(),$=y)}}else C.setFontSize(10),C.setFont("NotoSans","normal"),C.setTextColor(120),C.text("No roster data available",y,$),$+=30}if("attachments"===t){$=i(C,$,60);const t=l.attachments||[];if(t.length>0){const n=t.length>m?s(t,m):[t];for(let s=0;s<n.length;s++){const a=n[s];$=i(C,$,60),0===s&&(C.setFontSize(14),C.setFont("NotoSans","bold"),C.setTextColor(0),C.text("Attachments",y,$),$+=20);const l=a.map(t=>[t.name||"Unnamed file",t.type||"Unknown",t.uploaded_by||"Unknown",t.uploaded_at?new Date(t.uploaded_at).toLocaleDateString():"N/A"]);e(C,{startY:$,head:[["File Name","Type","Uploaded By","Date"]],body:l,theme:"striped",headStyles:{fillColor:[x,u,N],fontSize:10},margin:{left:y,right:y},styles:{fontSize:9}}),$=o(C,$)+10,s<n.length-1&&($=i(C,$,30),C.setFontSize(9),C.setFont("NotoSans","italic"),C.setTextColor(120),C.text(`(Continued - showing ${(s+1)*m} of ${t.length} attachments)`,y,$),$+=20,C.addPage(),$=y)}$=i(C,$,20),C.setFontSize(8),C.setFont("NotoSans","italic"),C.setTextColor(100),C.text("Note: Download full attachments from the Chravel app",y,$),$+=20}else C.setFontSize(10),C.setFont("NotoSans","normal"),C.setTextColor(120),C.text("No attachments available",y,$),$+=30}}z("finalizing",w.length+1,w.length+2,"Finalizing PDF...");const D=(null==S?void 0:S.footerText)||`Generated by Chravel • ${(new Date).toLocaleString()} • Trip ID: ${l.tripId}`,A=C.internal.pages.length-1;for(let t=1;t<=A;t++)C.setPage(t),C.setFontSize(8),C.setTextColor(120),C.text(D,y,b-20);return z("finalizing",w.length+2,w.length+2,"PDF ready!"),C.output("blob")}function i(t,e,o){return e+o>t.internal.pageSize.getHeight()-60?(t.addPage(),40):e}export{l as generateClientPDF};
