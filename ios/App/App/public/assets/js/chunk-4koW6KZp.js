import{x as t,y as e,z as a,A as r,s as n}from"../index-C69Cv9fm.js";import{d as i}from"./chunk-DGLf2uCM.js";const s=new class{getStorageKey(t){return`calendar_events_${t}`}async getEvents(e){try{return await t(this.getStorageKey(e),[])}catch(a){return[]}}async saveEvents(t,a){try{await e(this.getStorageKey(t),a)}catch(r){}}async createEvent(t){const e=await this.getEvents(t.trip_id),a={id:`demo-event-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,trip_id:t.trip_id,title:t.title,description:t.description,start_time:t.start_time,end_time:t.end_time,location:t.location,event_category:t.event_category||"other",include_in_itinerary:t.include_in_itinerary??!0,source_type:t.source_type||"manual",source_data:t.source_data||{},created_by:"demo-user",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};return e.push(a),e.sort((t,e)=>new Date(t.start_time).getTime()-new Date(e.start_time).getTime()),await this.saveEvents(t.trip_id,e),a}async updateEvent(t,e,a){const r=await this.getEvents(t),n=r.findIndex(t=>t.id===e);if(-1===n)return null;const i={...r[n],...a,updated_at:(new Date).toISOString()};return r[n]=i,r.sort((t,e)=>new Date(t.start_time).getTime()-new Date(e.start_time).getTime()),await this.saveEvents(t,r),i}async deleteEvent(t,e){const a=await this.getEvents(t),r=a.filter(t=>t.id!==e);return r.length!==a.length&&(await this.saveEvents(t,r),!0)}async clearEvents(t){await a(this.getStorageKey(t))}async clearAllDemoEvents(){const t=[];for(let e=0;e<(await r.getItem("length")?parseInt(await r.getItem("length")||"0"):0);e++){const a=`calendar_events_${e}`;await r.getItem(a)&&t.push(a)}for(const e of t)e.startsWith("calendar_events_")&&await a(e)}},o={async createEvent(t){try{if(await i.isDemoModeEnabled())return await s.createEvent(t);const{data:{user:e}}=await n.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:a,error:r}=await n.rpc("create_event_with_conflict_check",{p_trip_id:t.trip_id,p_title:t.title,p_description:t.description||"",p_location:t.location||"",p_start_time:t.start_time,p_end_time:t.end_time||null,p_created_by:e.id});if(r)throw r;const{data:o,error:c}=await n.from("trip_events").select("\n          *,\n          creator:created_by (\n            id,\n            display_name,\n            avatar_url\n          )\n        ").eq("id",a).single();if(c)throw c;return o}catch(e){return null}},async getTripEvents(t){try{if(await i.isDemoModeEnabled())return await s.getEvents(t);const{data:e,error:a}=await n.from("trip_events").select("\n          *,\n          creator:created_by (\n            id,\n            display_name,\n            avatar_url\n          )\n        ").eq("trip_id",t).order("start_time",{ascending:!0});if(a)throw a;return e||[]}catch(e){return[]}},async updateEvent(t,e){try{if(await i.isDemoModeEnabled()){const a=e.trip_id||t.split("-")[0];return null!==await s.updateEvent(a,t,e)}const{error:a}=await n.from("trip_events").update(e).eq("id",t);return!a}catch(a){return!1}},async deleteEvent(t,e){try{if(await i.isDemoModeEnabled())return!!e&&await s.deleteEvent(e,t);const{error:a}=await n.from("trip_events").delete().eq("id",t);return!a}catch(a){return!1}},convertToCalendarEvent(t){var e,a;return{id:t.id,title:t.title,date:new Date(t.start_time),time:new Date(t.start_time).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit"}),location:t.location,description:t.description,createdBy:t.created_by,creatorName:(null==(e=t.creator)?void 0:e.display_name)||"Unknown User",creatorAvatar:null==(a=t.creator)?void 0:a.avatar_url,include_in_itinerary:t.include_in_itinerary,event_category:t.event_category,source_type:t.source_type,source_data:t.source_data}},convertFromCalendarEvent(t,e){const a=new Date(t.date),[r,n]=t.time.split(":");return a.setHours(parseInt(r),parseInt(n)),{trip_id:e,title:t.title,description:t.description,start_time:a.toISOString(),location:t.location,event_category:t.event_category||"other",include_in_itinerary:t.include_in_itinerary,source_type:t.source_type||"manual",source_data:t.source_data||{}}}};export{o as c};
