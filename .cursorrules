# üß≠ CHRAVEL ENGINEERING MANIFESTO
> **For Cursor AI** - Read this file for all coding standards  
> **Quick Reference:** See `CLAUDE.md` for patterns and examples  
> **Full v7.0 Protocol:** See [`docs/ENGINEERING_PROTOCOL.md`](./docs/ENGINEERING_PROTOCOL.md) for comprehensive spec  
> **Non-negotiable:** Every edit must pass `npm run lint && npm run typecheck && npm run build` before commit

---

## ‚ö†Ô∏è CRITICAL: READ FULL DOCUMENTATION

This file provides quick reference. **For comprehensive standards, consult:**
- **`docs/ENGINEERING_PROTOCOL.md`** ‚Äî Full v7.0 Engineering Protocol
- **`CLAUDE.md`** ‚Äî Patterns and code examples
- **`docs/AI_AGENT_CONDUCT.md`** ‚Äî AI agent behavior rules

---

## ‚öôÔ∏è GLOBAL PRINCIPLES

### 1. Zero Syntax Errors
- Every `{}`, `()`, `[]`, and JSX tag must close cleanly
- Before returning code, mentally simulate: `npm run build`
- If uncertain about bracket balance ‚Üí simplify the structure

### 2. TypeScript Strict Mode
- `"strict": true` in `tsconfig.json` enforced
- All function parameters and return types explicitly typed
- No `any` types unless interfacing with untyped third-party libs (comment why)

### 3. Vite Production Environment
- Code must compile in fresh Node 18+ environment
- No experimental syntax (e.g., decorators, stage-3 proposals)
- Test locally with `npm run dev` before pushing

### 4. Readability > Cleverness
- Explicit variable names: `userTrips` not `ut`
- Separate concerns: one function = one responsibility
- Comment complex logic (especially map calculations, state transitions)

---

## üß† REACT PATTERNS

### Component Structure
```tsx
// ‚úÖ GOOD: Hooks first, handlers next, return last
export function TripCard({ trip }: { trip: Trip }) {
  const [isExpanded, setIsExpanded] = useState(false);
  const router = useNavigate();

  const handleExpand = useCallback(() => {
    setIsExpanded(prev => !prev);
  }, []);

  return <div>{/* JSX */}</div>;
}

// ‚ùå BAD: Hooks inside conditionals
if (user) {
  const [trips, setTrips] = useState([]); // BREAKS RULES OF HOOKS
}
```

### State Management Rules
- Always type `useState`: `const [trips, setTrips] = useState<Trip[]>([]);`
- Always cleanup in `useEffect` returns (prevent memory leaks)
- Compute derived state above return, don't store in state
- Memoize handlers passed as props with `useCallback`
- Guard against null/undefined in all handlers

---

## üóÑÔ∏è SUPABASE INTEGRATION

### Rules
1. **Never** call Supabase directly in JSX (`onClick={() => supabase.from...}`)
2. **Always** go through `/src/integrations/supabase/client.ts`
3. **Handle** `error` explicitly (don't ignore it)
4. **Type** results using generated `Database` types from Supabase CLI

### Standard Pattern
```tsx
const { data: trips, error } = await supabase
  .from('trips')
  .select('*')
  .eq('creator_id', userId);

if (error) {
  console.error('Failed to fetch trips:', error);
  setError(error.message);
  return;
}

setTrips(trips ?? []);
```

---

## üó∫Ô∏è GOOGLE MAPS / PLACES / LOCATION LOGIC

### Critical Rules
1. **One map instance per page** ‚Äî use props/context for mode changes
2. **Always null-check** `mapRef.current` before operations
3. **Debounce** high-frequency events (drag, zoom, bounds_changed)
4. **Clean up** event listeners in `useEffect` return
5. **Type all coordinates** as `{ lat: number; lng: number }`

### Map Initialization Pattern
```tsx
const mapRef = useRef<google.maps.Map | null>(null);
const mapContainerRef = useRef<HTMLDivElement>(null);

useEffect(() => {
  if (!mapContainerRef.current || mapRef.current) return;

  mapRef.current = new google.maps.Map(mapContainerRef.current, {
    center: { lat: 34.0522, lng: -118.2437 },
    zoom: 12,
    disableDefaultUI: false,
    zoomControl: true,
  });
}, []);
```

---

## üß∞ ERROR PREVENTION

### Pre-Commit Requirements
Every commit must pass:
```bash
npm run lint        # ESLint with auto-fix
npm run typecheck   # TypeScript validation
npm run build       # Production build test
```

### Common Errors to Avoid
- ‚ùå Unclosed brackets/braces
- ‚ùå Missing return statements in arrow functions
- ‚ùå Hooks inside conditionals
- ‚ùå Untyped state variables
- ‚ùå Ignoring error objects from async calls
- ‚ùå Not cleaning up event listeners

---

## ü§ñ AI AGENT CONDUCT

### Required Behavior
1. **Validate syntax** before returning code
2. **Test mentally:** Would `npm run build` pass?
3. **Preserve context:** Don't break existing working code
4. **Comment complex logic** (especially algorithms, state machines)
5. **Use stable APIs only** (no stage-3 proposals)

### Prohibited Actions
1. ‚ùå Outputting **partial code** that won't compile
2. ‚ùå Using **experimental syntax** not in TypeScript 5
3. ‚ùå Creating **duplicate implementations** of existing components
4. ‚ùå Ignoring **error objects** from async calls
5. ‚ùå Adding **console.log** without removing before commit

---

## ‚úÖ FINAL RULE

> **"If it doesn't build, it doesn't ship."**

Every change must:
1. Pass `npm run lint && npm run typecheck && npm run build`
2. Have clean syntax (balanced brackets, proper JSX)
3. Have explicit types (no `any` unless documented)
4. Follow patterns in **CLAUDE.md** (read it!)
5. Be ready for Vercel deployment

---

## üìö QUICK REFERENCE

### Key Files
- `/src/integrations/supabase/client.ts` ‚Äî Supabase singleton
- `/src/types/` ‚Äî Type definitions
- `/src/components/` ‚Äî Reusable components
- `/src/lib/` ‚Äî Utility functions

### Quick Commands
```bash
npm run dev          # Local dev server
npm run lint         # Check linting
npm run typecheck    # Check types
npm run build        # Production build
npm run validate     # Run all checks
```

---

## üìö Related Documentation

- [`docs/ENGINEERING_PROTOCOL.md`](./docs/ENGINEERING_PROTOCOL.md) ‚Äî **Full v7.0 Protocol**
- [`CLAUDE.md`](./CLAUDE.md) ‚Äî Patterns and examples
- [`docs/AI_AGENT_CONDUCT.md`](./docs/AI_AGENT_CONDUCT.md) ‚Äî AI agent quick reference

---

**Last Updated:** 2026-01-11
