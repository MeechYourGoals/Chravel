import{u as t,a as e}from"./chunk-DV9vF-NS.js";import{x as a,y as s,z as r,e as i,q as n,j as o,s as d}from"../index-C69Cv9fm.js";import{u}from"./chunk-Ccyq873b.js";import{r as l}from"./chunk-CHPtWMTz.js";const c=new class{getStorageKey(t){return`tasks_${t}`}async getTasks(t){try{return await a(this.getStorageKey(t),[])}catch(e){return[]}}async saveTasks(t,e){try{await s(this.getStorageKey(t),e)}catch(a){}}async createTask(t,e){const a=await this.getTasks(t),s={id:`demo-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,trip_id:t,creator_id:"demo-user",title:e.title,description:e.description,due_at:e.due_at,is_poll:e.is_poll,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),creator:{id:"demo-user",name:"You"},task_status:this.createInitialTaskStatus(e,"demo-user")};return a.unshift(s),await this.saveTasks(t,a),s}createInitialTaskStatus(t,e){if(t.is_poll)return t.assignedTo.map(t=>({task_id:"",user_id:t,completed:!1}));return(t.assignedTo.length>0?t.assignedTo:[e]).map(t=>({task_id:"",user_id:t,completed:!1}))}async toggleTask(t,e,a,s){var r;const i=await this.getTasks(t),n=i.findIndex(t=>t.id===e);if(-1===n)return null;const o=i[n],d=(null==(r=o.task_status)?void 0:r.findIndex(t=>t.user_id===a))??-1;return-1===d?(o.task_status=o.task_status||[],o.task_status.push({task_id:e,user_id:a,completed:s,completed_at:s?(new Date).toISOString():void 0})):o.task_status[d]={...o.task_status[d],completed:s,completed_at:s?(new Date).toISOString():void 0},o.updated_at=(new Date).toISOString(),await this.saveTasks(t,i),o}async deleteTask(t,e){const a=await this.getTasks(t),s=a.filter(t=>t.id!==e);return s.length!==a.length&&(await this.saveTasks(t,s),!0)}async clearTasks(t){await r(this.getStorageKey(t))}async clearAllDemoTasks(){}},_=t=>{if(!["1","2","3","4","5","6","7","8","9","10","11","12"].includes(t))return[];return{1:[{id:"seed-1-1",trip_id:t,creator_id:"seed-user",title:"Pack reef-safe sunscreen",description:"Make sure to bring sunscreen that won't damage the coral reefs",due_at:new Date(Date.now()+6048e5).toISOString(),is_poll:!1,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),creator:{id:"seed-user",name:"Trip Organizer"},task_status:[{task_id:"seed-1-1",user_id:"current-user",completed:!1}]},{id:"seed-1-2",trip_id:t,creator_id:"seed-user",title:"Download offline maps for Cancun",description:"Download Google Maps offline for the hotel and downtown areas",due_at:new Date(Date.now()+432e6).toISOString(),is_poll:!1,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),creator:{id:"seed-user",name:"Trip Organizer"},task_status:[{task_id:"seed-1-2",user_id:"current-user",completed:!1}]}],4:[{id:"seed-4-1",trip_id:t,creator_id:"seed-user",title:"Coordinate ride to Broadway bars",description:"Book Uber/Lyft for the group to hit the honky-tonk scene",due_at:new Date(Date.now()+2592e5).toISOString(),is_poll:!1,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),creator:{id:"seed-user",name:"Ashley"},task_status:[{task_id:"seed-4-1",user_id:"current-user",completed:!1}]}],6:[{id:"seed-6-1",trip_id:t,creator_id:"seed-user",title:"Pack hiking boots for everyone",description:"Make sure everyone has proper footwear for the mountain trails",due_at:new Date(Date.now()+3456e5).toISOString(),is_poll:!1,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),creator:{id:"seed-user",name:"Dad (Mike)"},task_status:[{task_id:"seed-6-1",user_id:"current-user",completed:!1}]}],7:[{id:"seed-7-1",trip_id:t,creator_id:"seed-user",title:"Bring poker chips for evening games",description:"Someone needs to pack the poker set for our nightly tournaments",due_at:new Date(Date.now()+5184e5).toISOString(),is_poll:!1,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),creator:{id:"seed-user",name:"Commissioner Mike"},task_status:[{task_id:"seed-7-1",user_id:"current-user",completed:!1}]}]}[t]||[]},p=(a,s)=>{const{isDemoMode:r}=u(),{user:p}=i(),k=n(),{toast:g}=o(),[m,w]=l.useState(""),[h,S]=l.useState(""),[v,f]=l.useState(),[y,T]=l.useState("solo"),[D,I]=l.useState([]),[b,O]=l.useState("all"),[M,C]=l.useState(),[F,q]=l.useState({}),[A,U]=l.useState("dueDate"),E=l.useCallback(()=>m.trim()?m.length>140?{isValid:!1,error:"Task title must be 140 characters or less"}:{isValid:!0}:{isValid:!1,error:"Task title is required"},[m]),K=l.useCallback(()=>E().isValid?{title:m.trim(),description:h.trim()||void 0,due_at:null==v?void 0:v.toISOString(),is_poll:"poll"===y,assignedTo:D.length>0?D:void 0}:null,[m,h,v,y,D,E]),x=l.useCallback(()=>{w(""),S(""),f(void 0),T("solo"),I([])},[]),P=l.useCallback(async(t,e)=>{try{return!0}catch(a){return g({title:"Failed to assign task",variant:"destructive"}),!1}},[g]),j=l.useCallback(async t=>{try{const{taskId:e,userIds:a}=t;return g({title:`Assigned to ${a.length} members`}),!0}catch(e){return g({title:"Failed to assign task to members",variant:"destructive"}),!1}},[g]),B=l.useCallback(t=>{let e=t.filter(t=>{var e,a,s,r,i;const n=t.is_poll?((null==(e=t.task_status)?void 0:e.filter(t=>t.completed).length)||0)>=((null==(a=t.task_status)?void 0:a.length)||1):(null==(r=null==(s=t.task_status)?void 0:s[0])?void 0:r.completed)||!1;if("open"===b&&n)return!1;if("completed"===b&&!n)return!1;if(M){if(!(null==(i=t.task_status)?void 0:i.some(t=>t.user_id===M)))return!1}if(t.due_at){const e=new Date(t.due_at);if(F.start&&e<F.start)return!1;if(F.end&&e>F.end)return!1}return!0});return e.sort((t,e)=>{switch(A){case"dueDate":return t.due_at?e.due_at?new Date(t.due_at).getTime()-new Date(e.due_at).getTime():-1:1;case"created":return new Date(e.created_at).getTime()-new Date(t.created_at).getTime();case"priority":const a=t.due_at?1:0;return(e.due_at?1:0)-a;default:return 0}}),e},[b,M,F,A]),Q=l.useCallback(()=>{O("all"),C(void 0),q({}),U("dueDate")},[]),V=l.useMemo(()=>"all"!==b||void 0!==M||void 0!==F.start||void 0!==F.end,[b,M,F]),R=t({queryKey:["tripTasks",a,r],queryFn:async()=>{if(r||!p){const t=await c.getTasks(a);return 0===t.length?_(a):t}try{const{data:t,error:e}=await d.from("trip_tasks").select("\n          *,\n          task_status(*),\n          creator:creator_id (\n            id,\n            display_name,\n            avatar_url\n          )\n        ").eq("trip_id",a).order("created_at",{ascending:!1});if(e)throw e;return t&&0!==t.length?t.map(t=>{var e,a;return{id:t.id,trip_id:t.trip_id,creator_id:t.creator_id,title:t.title,description:t.description,due_at:t.due_at,is_poll:t.is_poll,created_at:t.created_at,updated_at:t.updated_at,creator:{id:t.creator_id,name:(null==(e=t.creator)?void 0:e.display_name)||"Unknown User",avatar:null==(a=t.creator)?void 0:a.avatar_url},task_status:t.task_status||[]}}):_(a)}catch(t){const e=await c.getTasks(a);return e.length>0?e:_(a)}},enabled:!!a}),$=e({mutationFn:async t=>{if(r||!p){const e=t.assignedTo||["demo-user"];return await c.createTask(a,{...t,assignedTo:e})}const{data:{user:e}}=await d.auth.getUser();if(!e)throw new Error("Please sign in to create tasks");const{error:s}=await d.rpc("ensure_trip_membership",{p_trip_id:a,p_user_id:e.id});if(s)throw new Error("Unable to join trip. Please try again.");const{data:i}=await d.from("profiles").select("display_name, avatar_url").eq("user_id",e.id).single(),{data:n,error:o}=await d.from("trip_tasks").insert({trip_id:a,creator_id:e.id,title:t.title,description:t.description,due_at:t.due_at,is_poll:t.is_poll}).select().single();if(o){if("PGRST116"===o.code)throw new Error("Access denied. You must be a trip member to create tasks.");throw o}return await d.from("task_status").insert({task_id:n.id,user_id:e.id,completed:!1}),{id:n.id,trip_id:n.trip_id,creator_id:n.creator_id,title:n.title,description:n.description,due_at:n.due_at,is_poll:n.is_poll,created_at:n.created_at,updated_at:n.updated_at,creator:{id:e.id,name:(null==i?void 0:i.display_name)||"Unknown User",avatar:null==i?void 0:i.avatar_url},task_status:[{task_id:n.id,user_id:e.id,completed:!1}]}},onSuccess:()=>{k.invalidateQueries({queryKey:["tripTasks",a]}),g({title:"Task created",description:"Your task has been added to the list."})},onError:t=>{const e=t.message||"Failed to create task. Please try again.";g({title:"Error Creating Task",description:e,variant:"destructive"})}}),z=e({mutationFn:async({taskId:t,completed:e})=>{if(r||!p){const s=(null==p?void 0:p.id)||"demo-user";return await c.toggleTask(a,t,s,e)}const{data:{user:s}}=await d.auth.getUser();if(!s)throw new Error("User not authenticated");const{data:i,error:n}=await d.from("trip_tasks").select("version").eq("id",t).single();if(n)throw n;const{error:o}=await d.rpc("toggle_task_status",{p_task_id:t,p_user_id:s.id,p_completed:e,p_current_version:i.version});if(o)throw o;return{taskId:t,completed:e}},onMutate:async({taskId:t,completed:e})=>{await k.cancelQueries({queryKey:["tripTasks",a]});const s=k.getQueryData(["tripTasks",a]);return k.setQueryData(["tripTasks",a],a=>a?a.map(a=>{var s;if(a.id===t){const t=(null==p?void 0:p.id)||"demo-user",r=null==(s=a.task_status)?void 0:s.map(a=>a.user_id===t?{...a,completed:e,completed_at:e?(new Date).toISOString():void 0}:a);return{...a,task_status:r}}return a}):a),{previousTasks:s}},onError:(t,e,s)=>{(null==s?void 0:s.previousTasks)&&k.setQueryData(["tripTasks",a],s.previousTasks),g({title:"Error",description:"Failed to update task. Please try again.",variant:"destructive"})},onSettled:()=>{k.invalidateQueries({queryKey:["tripTasks",a,r]})}});return{tasks:R.data||[],isLoading:R.isLoading,error:R.error,title:m,description:h,dueDate:v,taskMode:y,assignedMembers:D,isValid:E().isValid,characterCount:m.length,maxCharacters:140,setTitle:w,setDescription:S,setDueDate:f,setTaskMode:T,updateAssignedMembers:I,toggleMember:t=>{I(e=>e.includes(t)?e.filter(e=>e!==t):[...e,t])},validateTask:E,getTaskData:K,resetForm:x,status:b,assignee:M,dateRange:F,sortBy:A,hasActiveFilters:V,setStatus:O,setAssignee:C,setDateRange:q,setSortBy:U,applyFilters:B,clearFilters:Q,assignTask:P,bulkAssign:j,autoAssignByRole:async(t,e)=>{},createTaskMutation:$,toggleTaskMutation:z}};export{p as u};
