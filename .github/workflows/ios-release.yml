# =============================================================================
# Chravel iOS Release Workflow
# GitHub Actions CI/CD for iOS App Store releases
# =============================================================================

name: iOS Release

on:
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - appstore
          - validate_only
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major
      changelog:
        description: 'Release notes / changelog'
        required: false
        default: 'Bug fixes and improvements'

  # Auto-trigger on tags
  push:
    tags:
      - 'v*.*.*'

# Cancel in-progress runs for same ref
concurrency:
  group: ios-release-${{ github.ref }}
  cancel-in-progress: true

env:
  # Xcode version
  XCODE_VERSION: '15.4'

  # Node version
  NODE_VERSION: '20'

  # Ruby version for Fastlane
  RUBY_VERSION: '3.2'

  # Cache key prefix
  CACHE_KEY: 'ios-v1'

jobs:
  # ===========================================================================
  # Build and Test
  # ===========================================================================
  build:
    name: Build iOS App
    runs-on: macos-14
    timeout-minutes: 60

    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}

    steps:
      # -----------------------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------------------
      # Setup Environment
      # -----------------------------------------------------------------------
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: ios-release/fastlane

      - name: Install Fastlane
        run: |
          cd ios-release/fastlane
          bundle install

      # -----------------------------------------------------------------------
      # Cache
      # -----------------------------------------------------------------------
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/App/Pods
          key: ${{ env.CACHE_KEY }}-pods-${{ hashFiles('ios/App/Podfile.lock') }}
          restore-keys: |
            ${{ env.CACHE_KEY }}-pods-

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ios-release/fastlane/build/DerivedData
          key: ${{ env.CACHE_KEY }}-derived-${{ github.sha }}
          restore-keys: |
            ${{ env.CACHE_KEY }}-derived-

      # -----------------------------------------------------------------------
      # Install Dependencies
      # -----------------------------------------------------------------------
      - name: Install npm dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install

      # -----------------------------------------------------------------------
      # Code Signing
      # -----------------------------------------------------------------------
      - name: Setup Keychain
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

      - name: Import certificates
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Decode certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > certificate.p12

          # Import to keychain
          security import certificate.p12 -k build.keychain \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          # Allow codesign access
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # Cleanup
          rm certificate.p12

      - name: Install provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Create profiles directory
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          # Decode and install profile
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode \
            > ~/Library/MobileDevice/Provisioning\ Profiles/chravel_appstore.mobileprovision

      # -----------------------------------------------------------------------
      # Version Management
      # -----------------------------------------------------------------------
      - name: Bump version
        if: ${{ github.event.inputs.version_bump != 'none' }}
        run: |
          cd ios-release/fastlane
          bundle exec fastlane bump_version type:${{ github.event.inputs.version_bump }}

      - name: Bump build number
        run: |
          cd ios-release/fastlane
          bundle exec fastlane bump_build

      - name: Get version info
        id: version
        run: |
          cd ios/App
          VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" App/Info.plist)
          BUILD=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" App/Info.plist)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD" >> $GITHUB_OUTPUT
          echo "ðŸ“± Version: $VERSION ($BUILD)"

      # -----------------------------------------------------------------------
      # Build
      # -----------------------------------------------------------------------
      - name: Build iOS app
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd ios-release/fastlane
          bundle exec fastlane build

      # -----------------------------------------------------------------------
      # Validate (optional)
      # -----------------------------------------------------------------------
      - name: Validate build
        if: ${{ github.event.inputs.release_type == 'validate_only' }}
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          cd ios-release/fastlane
          bundle exec fastlane validate

      # -----------------------------------------------------------------------
      # Upload Artifact
      # -----------------------------------------------------------------------
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: chravel-ios-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_number }}
          path: ios-release/fastlane/build/Chravel.ipa
          retention-days: 14

      - name: Upload dSYM artifact
        uses: actions/upload-artifact@v4
        with:
          name: chravel-dsym-${{ steps.version.outputs.version }}-${{ steps.version.outputs.build_number }}
          path: ios-release/fastlane/build/*.dSYM.zip
          retention-days: 30

  # ===========================================================================
  # Deploy to TestFlight
  # ===========================================================================
  deploy-testflight:
    name: Deploy to TestFlight
    needs: build
    runs-on: macos-14
    if: ${{ github.event.inputs.release_type == 'testflight' || github.event.inputs.release_type == 'appstore' }}
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: ios-release/fastlane

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: chravel-ios-${{ needs.build.outputs.version }}-${{ needs.build.outputs.build_number }}
          path: ios-release/fastlane/build

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd ios-release/fastlane
          bundle exec fastlane pilot upload \
            --ipa build/Chravel.ipa \
            --changelog "${{ github.event.inputs.changelog }}" \
            --skip_waiting_for_build_processing

      - name: Notify success
        if: success()
        run: |
          echo "âœ… Successfully uploaded v${{ needs.build.outputs.version }} (${{ needs.build.outputs.build_number }}) to TestFlight!"

  # ===========================================================================
  # Submit to App Store
  # ===========================================================================
  submit-appstore:
    name: Submit to App Store
    needs: [build, deploy-testflight]
    runs-on: macos-14
    if: ${{ github.event.inputs.release_type == 'appstore' }}
    timeout-minutes: 30
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: ios-release/fastlane

      - name: Submit for App Store Review
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd ios-release/fastlane
          bundle exec fastlane submit_for_review

      - name: Notify submission
        if: success()
        run: |
          echo "ðŸ“± v${{ needs.build.outputs.version }} submitted to App Store for review!"

  # ===========================================================================
  # Upload dSYMs to Crash Reporter
  # ===========================================================================
  upload-dsyms:
    name: Upload dSYMs
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.release_type != 'validate_only' }}
    timeout-minutes: 10
    env:
      HAS_SENTRY_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN != '' }}

    steps:
      - name: Download dSYM artifact
        uses: actions/download-artifact@v4
        with:
          name: chravel-dsym-${{ needs.build.outputs.version }}-${{ needs.build.outputs.build_number }}
          path: dsyms

      - name: Upload to Sentry
        if: ${{ env.HAS_SENTRY_TOKEN == 'true' }}
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          npm install -g @sentry/cli
          sentry-cli upload-dif --org $SENTRY_ORG --project $SENTRY_PROJECT dsyms/

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    needs: [build, deploy-testflight]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: chravel-ios-${{ needs.build.outputs.version }}-${{ needs.build.outputs.build_number }}
          path: release

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ needs.build.outputs.version }}
          body: |
            ## Chravel iOS v${{ needs.build.outputs.version }}

            Build: ${{ needs.build.outputs.build_number }}

            ${{ github.event.inputs.changelog }}

            ---
            ðŸ“± [TestFlight](https://testflight.apple.com/join/YOUR_LINK)
          files: |
            release/Chravel.ipa
          draft: false
          prerelease: ${{ github.event.inputs.release_type == 'testflight' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
