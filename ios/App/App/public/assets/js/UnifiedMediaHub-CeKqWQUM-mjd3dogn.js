import{j as e}from"./ui-vendor-BO3EQrMK-mjd3dogn.js";import{r as t,R as a}from"./react-vendor-D1R0t5S0-mjd3dogn.js";import{T as s,a as r,b as i,c as n}from"./tabs-Dxuz3Y6S-mjd3dogn.js";import{n as l,L as o,V as d,o as m,p as c,q as u,r as h,s as p,t as x,v as g,w as f,x as j}from"./TripDetailModals-BpnQZ47b-mjd3dogn.js";import{c as v,u as w,d as y,B as b,X as N,l as _,t as S,s as k,N as C}from"./index-Ta7FH5xW-mjd3dogn.js";import{B as I}from"./badge-DyE_ZUPM-mjd3dogn.js";import{D as A,G as P}from"./switch-GKuTbu---mjd3dogn.js";import{D as M,x as D,M as L}from"./SettingsMenu-DFNATHGY-mjd3dogn.js";import{Z as $}from"./zap-LZcBFzwj-mjd3dogn.js";import{AddLinkModal as z}from"./AddLinkModal-BcpZ7zHk-mjd3dogn.js";import{E as T}from"./external-link-CqAT5ABV-mjd3dogn.js";import{L as F}from"./loader-circle-C0Dqayt8-mjd3dogn.js";import{C as U}from"./camera-AJLsIMdA-mjd3dogn.js";import{F as R,n as B,C as V}from"./tripConverter-C1IUbOIF-mjd3dogn.js";import{U as q}from"./users-B07yK8Y7-mjd3dogn.js";import{c as O}from"./calendar-ylgcJK3b-mjd3dogn.js";import{P as E}from"./progress-D31nnzej-mjd3dogn.js";import{P as W}from"./plus-Dhwa7sZY-mjd3dogn.js";import{M as Q}from"./map-pin-BtCU-LeS-mjd3dogn.js";import{C as G}from"./calendar-C9K0fVga-mjd3dogn.js";import{I as Y}from"./input-DsI2n-oJ-mjd3dogn.js";import{S as H}from"./eventsMockData-BWXZ-nj7-mjd3dogn.js";import"./tripsData-DKwZ96V_-mjd3dogn.js";import"./dropdown-menu-BXaKb4pk-mjd3dogn.js";import"./chevron-right-DKRZr0Ps-mjd3dogn.js";import"./select-CMjqEsxb-mjd3dogn.js";import"./label-D_iG0y88-mjd3dogn.js";import"./card-jeNxgMYk-mjd3dogn.js";import"./dialog-BcLamxvL-mjd3dogn.js";import"./supabase-DyX-XggK-mjd3dogn.js";import"./user-DFuJ2ZP3-mjd3dogn.js";import"./textarea-BudkfAn8-mjd3dogn.js";import"./utils-DD44zzh--mjd3dogn.js";import"./googlePlacesNew-Dl7cAwDK-mjd3dogn.js";import"./circle-check-big-Bvor9_sf-mjd3dogn.js";import"./chevron-left-C1xtDQ_l-mjd3dogn.js";import"./avatar-HCmfb6Ad-mjd3dogn.js";import"./circle-alert-CX60mGhN-mjd3dogn.js";import"./clock-CbBGjTQx-mjd3dogn.js";import"./chart-column-DOJCLy2J-mjd3dogn.js";import"./BillingSection-CjHrdMm3-mjd3dogn.js";import"./building-QMpp1aWF-mjd3dogn.js";import"./pro-CZgaTEEg-mjd3dogn.js";import"./circle-check-CNnkiDfZ-mjd3dogn.js";import"./charts-CLK9EMgA-mjd3dogn.js";import"./share-2-DwO-SOoB-mjd3dogn.js";import"./AuthModal-BKw70HSh-mjd3dogn.js";import"./arrow-left-Biq1qnK6-mjd3dogn.js";import"./mail-BdBVrsyz-mjd3dogn.js";import"./eye-BNDPAvT6-mjd3dogn.js";import"./SavedRecommendations-D-6cIfyL-mjd3dogn.js";import"./useSavedRecommendations-DTox9Xl2-mjd3dogn.js";import"./shield-DGBvlKQi-mjd3dogn.js";import"./trending-up-B0a-0y1l-mjd3dogn.js";import"./userPreferencesService-DregIO64-mjd3dogn.js";import"./archive-zX2FvEif-mjd3dogn.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=v("Instagram",[["rect",{width:"20",height:"20",x:"2",y:"2",rx:"5",ry:"5",key:"2e1cvw"}],["path",{d:"M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z",key:"9exkf1"}],["line",{x1:"17.5",x2:"17.51",y1:"6.5",y2:"6.5",key:"r4j83e"}]]),K=v("Youtube",[["path",{d:"M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17",key:"1q2vi4"}],["path",{d:"m10 15 5-3-5-3z",key:"1jp15x"}]]),X=({method:t,size:a=20})=>{const s={size:a,className:Z(t)};switch(t){case"venmo":case"applecash":return e.jsx(M,{...s});case"cashapp":default:return e.jsx(A,{...s});case"zelle":return e.jsx($,{...s});case"paypal":return e.jsx(D,{...s})}},Z=e=>{switch(e){case"venmo":return"text-blue-400";case"cashapp":return"text-emerald-400";case"zelle":return"text-purple-400";case"paypal":return"text-blue-500";case"applecash":return"text-gray-200";default:return"text-gray-400"}},ee=({item:t,onOpenVideo:a,onDelete:s,isDeleting:r})=>{var i;const n=l({url:t.media_url,metadata:t.metadata});return e.jsxs("div",{className:"group relative aspect-square rounded-lg overflow-hidden bg-muted cursor-pointer",onClick:e=>{e.stopPropagation(),"video"===t.media_type&&a(t)},children:["image"===t.media_type?e.jsx("img",{src:n??t.media_url,alt:t.filename,className:"w-full h-full object-cover transition-transform group-hover:scale-105"}):e.jsxs("div",{className:"relative w-full h-full bg-black flex items-center justify-center",children:[e.jsx("video",{src:n??t.media_url,className:"w-full h-full object-cover",muted:!0,playsInline:!0,preload:"metadata"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 pointer-events-none",children:e.jsx(O,{className:"w-12 h-12 text-white"})}),(null==(i=t.metadata)?void 0:i.duration)&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded pointer-events-none",children:[Math.floor(t.metadata.duration/60),":",(t.metadata.duration%60).toString().padStart(2,"0")]})]}),e.jsx("button",{onClick:e=>s(t.id,e),disabled:r,className:"absolute top-2 right-2 z-10 rounded-full bg-black/70 p-2 text-white hover:bg-destructive transition-colors",children:r?e.jsx(F,{className:"w-4 h-4 animate-spin"}):e.jsx(_,{className:"w-4 h-4"})}),e.jsxs("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors pointer-events-none",children:[e.jsx("div",{className:"absolute top-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("div",{className:"flex items-center gap-1",children:"chat"===t.source?e.jsx(L,{className:"w-4 h-4 text-white bg-black/50 rounded p-0.5"}):e.jsx(T,{className:"w-4 h-4 text-white bg-black/50 rounded p-0.5"})})}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("p",{className:"text-white text-sm font-medium truncate",children:t.filename}),e.jsx("p",{className:"text-white/80 text-xs",children:"chat"===t.source?"From chat":"Uploaded"})]})]})]})},te=({items:a,type:s,searchQuery:r,tripId:i,onMediaUploaded:n,onDeleteItem:u})=>{const[h,p]=t.useState(!1),[x,g]=t.useState(!1),[f,j]=t.useState(null),[v,C]=t.useState(new Set),P=t.useRef(null),M=t.useRef(null),D=t.useRef(null),{user:L}=w(),{isDemoMode:$}=y(),V=l({url:(null==f?void 0:f.media_url)??null,metadata:null==f?void 0:f.metadata}),O=async(e,t)=>{if(t.stopPropagation(),!v.has(e)){C(t=>new Set(t).add(e));try{if(u)return await u(e),void(null==n||n());if($)return void S.success("Item deleted (demo mode)");await m.deleteMedia(e),S.success("Item deleted"),null==n||n()}catch(a){S.error("Failed to delete item")}finally{C(t=>{const a=new Set(t);return a.delete(e),a})}}},E=e=>e.startsWith("image/")?"image":e.startsWith("video/")?"video":"document",W=async(e,t)=>{if(e&&0!==e.length)if(i)if($)S.success(`${e.length} file(s) uploaded (demo mode)`);else if(L){g(!0);try{let a=0;for(const s of Array.from(e)){const e=E(s.type);let r=e;if("photos"===t){if("image"!==e){if("video"!==e){S.error(`"${s.name}" is not a photo`);continue}S.info(`Video "${s.name}" will be saved to Videos tab`),r="video"}}else if("videos"===t){if("video"!==e){if("image"!==e){S.error(`"${s.name}" is not a video`);continue}S.info(`Photo "${s.name}" will be saved to Photos tab`),r="image"}}else if("files"===t){if("image"===e||"video"===e){S.error(`Please upload photos/videos in the ${"image"===e?"Photos":"Videos"} tab`);continue}r="document"}const n=`${i}/${L.id}/${Date.now()}-${s.name}`,l=c(s),{data:o,error:d}=await k.storage.from("trip-media").upload(n,s,{cacheControl:"3600",upsert:!1,contentType:l});if(d){S.error(`Failed to upload ${s.name}`);continue}const{data:m}=k.storage.from("trip-media").getPublicUrl(n),{error:u}=await k.from("trip_media_index").insert({trip_id:i,media_url:m.publicUrl,filename:s.name,media_type:r,file_size:s.size,mime_type:l,metadata:{upload_path:n,uploaded_by:L.id}});u?S.error(`Failed to save ${s.name} metadata`):a++}a>0&&(S.success(`${a} file(s) uploaded successfully!`),await new Promise(e=>setTimeout(e,600)),null==n||n())}catch(a){S.error("Failed to upload files")}finally{g(!1)}}else S.error("Please sign in to upload files");else S.error("Trip ID is required for uploads")},Q=e=>new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),G=e=>{if(!e)return"";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["Bytes","KB","MB","GB"][t]},Y=e=>{var t,a;if((null==(t=e.metadata)?void 0:t.preferredMethod)&&(null==(a=e.metadata)?void 0:a.perPersonAmount)){const t=((e,t,a)=>{const s=t.toFixed(2);switch(e){case"venmo":return`venmo://paycharge?txn=pay&recipients=${encodeURIComponent(a)}&amount=${s}&note=${encodeURIComponent("Trip expense")}`;case"cashapp":return`https://cash.app/$${encodeURIComponent(a)}/${s}`;case"zelle":return"https://www.zellepay.com/send-money";case"paypal":return`https://paypal.me/${encodeURIComponent(a)}/${s}`;default:return null}})(e.metadata.preferredMethod,e.metadata.perPersonAmount,"Trip Member");t&&window.open(t,"_blank")}};if("urls"===s){const t=a;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-muted/30 rounded-lg",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["All Links (",t.length,")"]}),e.jsxs(b,{variant:"ghost",size:"sm",onClick:()=>p(!0),className:"text-xs",children:[e.jsx(o,{className:"w-4 h-4 mr-1"}),"+ Add Link"]})]}),0===t.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(o,{className:"mx-auto h-8 w-8 text-muted-foreground mb-2"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Links shared in chat will appear here automatically"})]}):null,t.length>0&&t.map(t=>e.jsx("div",{className:"bg-card border rounded-lg p-4 hover:bg-card/80 transition-colors",children:e.jsxs("div",{className:"flex gap-4",children:[t.image_url&&e.jsx("img",{src:t.image_url,alt:t.title,className:"w-20 h-20 rounded-lg object-cover flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"text-foreground font-medium text-sm mb-1 truncate",children:t.title}),e.jsx("p",{className:"text-muted-foreground text-xs mb-2 line-clamp-2",children:t.description}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsx("span",{children:t.domain}),e.jsx("span",{children:Q(t.created_at)}),e.jsx(I,{variant:"outline",className:"text-xs",children:"chat"===t.source?"From chat":"places"===t.source?"From Places":"Manual"})]}),e.jsxs(b,{size:"sm",variant:"outline",onClick:()=>window.open(t.url,"_blank"),className:"text-xs",children:[e.jsx(T,{className:"w-3 h-3 mr-1"}),"Open"]})]})]})]})},t.id)),e.jsx(z,{isOpen:h,onClose:()=>p(!1)}),f&&e.jsxs("div",{className:"fixed inset-0 z-50 bg-black/95 flex items-center justify-center",onClick:()=>j(null),children:[e.jsx("button",{className:"absolute top-4 right-4 z-10 text-white bg-white/20 rounded-full p-2 hover:bg-white/30 transition-colors",onClick:()=>j(null),children:e.jsx(N,{className:"w-6 h-6"})}),e.jsx("video",{src:V??f.media_url,controls:!0,autoPlay:!0,playsInline:!0,muted:!0,controlsList:"nodownload",preload:"metadata",className:"max-w-full max-h-full",style:{maxWidth:"90vw",maxHeight:"90vh",width:"auto",height:"auto"},onClick:e=>e.stopPropagation()})]})]})}const H=a;if("photos"===s||"videos"===s)return e.jsxs("div",{className:"space-y-4",children:[e.jsx("input",{ref:P,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:e=>W(e.target.files,"photos")}),e.jsx("input",{ref:M,type:"file",accept:"video/*",multiple:!0,className:"hidden",onChange:e=>W(e.target.files,"videos")}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["photos"===s?"Photos":"Videos"," (",H.length,")"]}),e.jsxs(b,{variant:"ghost",size:"sm",onClick:()=>{var e,t;"photos"===s?null==(e=P.current)||e.click():null==(t=M.current)||t.click()},disabled:x,className:"text-xs",children:[x?e.jsx(F,{className:"w-4 h-4 mr-1 animate-spin"}):"photos"===s?e.jsx(U,{className:"w-4 h-4 mr-1"}):e.jsx(d,{className:"w-4 h-4 mr-1"}),"+ Add ","photos"===s?"Photo":"Video"]})]}),0===H.length?e.jsxs("div",{className:"text-center py-8",children:["photos"===s?e.jsx(U,{className:"mx-auto h-8 w-8 text-muted-foreground mb-2"}):e.jsx(d,{className:"mx-auto h-8 w-8 text-muted-foreground mb-2"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:r?e.jsxs(e.Fragment,{children:["No ",s,' found matching "',r,'". Try a different search term.']}):e.jsxs(e.Fragment,{children:[s.charAt(0).toUpperCase()+s.slice(1)," shared in chat will appear here"]})})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:H.map(t=>e.jsx(ee,{item:t,onOpenVideo:e=>j(e),onDelete:O,isDeleting:v.has(t.id)},t.id))}),f&&e.jsxs("div",{className:"fixed inset-0 z-50 bg-black/95 flex items-center justify-center",onClick:()=>j(null),children:[e.jsx("button",{className:"absolute top-4 right-4 z-10 text-white bg-white/20 rounded-full p-2 hover:bg-white/30 transition-colors",onClick:()=>j(null),children:e.jsx(N,{className:"w-6 h-6"})}),e.jsx("video",{src:V??f.media_url,controls:!0,autoPlay:!0,playsInline:!0,muted:!0,controlsList:"nodownload",preload:"metadata",className:"max-w-full max-h-full",style:{maxWidth:"90vw",maxHeight:"90vh",width:"auto",height:"auto"},onClick:e=>e.stopPropagation()})]})]});if("files"===s){const t=H.filter(e=>{var t,a,s;return"document"===e.media_type||"image"===e.media_type&&((null==(t=e.metadata)?void 0:t.isSchedule)||(null==(a=e.metadata)?void 0:a.isReceipt)||(null==(s=e.metadata)?void 0:s.isTicket))});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("input",{ref:D,type:"file",accept:"*/*",multiple:!0,className:"hidden",onChange:e=>W(e.target.files,"files")}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["Files (",t.length,")"]}),e.jsxs(b,{variant:"ghost",size:"sm",onClick:()=>{var e;return null==(e=D.current)?void 0:e.click()},disabled:x,className:"text-xs",children:[x?e.jsx(F,{className:"w-4 h-4 mr-1 animate-spin"}):e.jsx(R,{className:"w-4 h-4 mr-1"}),"+ Add File"]})]}),0===t.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(R,{className:"mx-auto h-8 w-8 text-muted-foreground mb-2"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:r?e.jsxs(e.Fragment,{children:['No files found matching "',r,'". Try a different search term.']}):e.jsx(e.Fragment,{children:"Documents, receipts, and schedules shared in chat will appear here"})})]}):e.jsx("div",{className:"space-y-3",children:t.map(t=>{var a,s,r,i,n,l,o,d,m,c;return e.jsx("div",{className:"bg-card border rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[(null==(a=t.metadata)?void 0:a.isReceipt)||(null==(s=t.metadata)?void 0:s.isSchedule)?e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:t.media_url,alt:t.filename,className:"w-12 h-12 rounded-lg object-cover"})}):e.jsx("div",{className:"flex-shrink-0",children:e.jsx(R,{className:"text-blue-400",size:20})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-foreground font-medium truncate",children:t.filename}),(null==(r=t.metadata)?void 0:r.isReceipt)&&e.jsx(I,{variant:"outline",className:"text-green-400 border-green-400/50",children:"Receipt"}),(null==(i=t.metadata)?void 0:i.isTicket)&&e.jsx(I,{variant:"outline",className:"text-blue-400 border-blue-400/50",children:"Ticket"}),(null==(n=t.metadata)?void 0:n.isSchedule)&&e.jsx(I,{variant:"outline",className:"text-orange-400 border-orange-400/50",children:"Schedule"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-muted-foreground mb-1",children:[e.jsx("span",{children:G(t.file_size)}),e.jsx("span",{children:"chat"===t.source?"From chat":"Uploaded"}),e.jsx("span",{children:Q(t.created_at)}),(null==(l=t.metadata)?void 0:l.extractedEvents)&&e.jsxs(I,{variant:"outline",className:"text-orange-400 border-orange-400/50",children:[t.metadata.extractedEvents," events"]})]}),(null==(o=t.metadata)?void 0:o.isReceipt)&&(null==(d=t.metadata)?void 0:d.totalAmount)&&e.jsxs("div",{className:"flex items-center gap-4 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{size:14,className:"text-green-400"}),e.jsxs("span",{className:"text-foreground text-sm font-medium",children:["$",t.metadata.totalAmount.toFixed(2)]})]}),t.metadata.splitCount&&t.metadata.perPersonAmount&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(q,{size:14,className:"text-blue-400"}),e.jsxs("span",{className:"text-muted-foreground text-sm",children:["$",t.metadata.perPersonAmount.toFixed(2)," each (",t.metadata.splitCount," people)"]})]}),t.metadata.preferredMethod&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{method:t.metadata.preferredMethod,size:14}),e.jsx("span",{className:"text-muted-foreground text-sm capitalize",children:t.metadata.preferredMethod})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[(null==(m=t.metadata)?void 0:m.isReceipt)&&(null==(c=t.metadata)?void 0:c.perPersonAmount)&&e.jsxs(b,{onClick:()=>Y(t),size:"sm",className:"bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:from-green-600 hover:to-emerald-600",children:["Pay $",t.metadata.perPersonAmount.toFixed(2)]}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>window.open(t.media_url,"_blank"),className:"text-muted-foreground hover:text-foreground",children:e.jsx(B,{size:16})}),e.jsx(b,{variant:"ghost",size:"sm",onClick:e=>O(t.id,e),disabled:v.has(t.id),className:"text-muted-foreground hover:text-destructive",children:v.has(t.id)?e.jsx(F,{size:16,className:"animate-spin"}):e.jsx(_,{size:16})})]})]})},t.id)})})]})}};
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function ae({id:t,url:a,mimeType:s,fileName:r,metadata:i,onDelete:n,onView:l}){const o=s.startsWith("video/"),d=s.startsWith("image/"),m=o||d;return e.jsxs("div",{className:"relative rounded-xl overflow-hidden bg-neutral-900 group",children:[e.jsx("button",{onClick:e=>{e.stopPropagation(),n(t)},className:"absolute top-2 right-2 z-10 rounded-full bg-black/70 p-2 text-white hover:bg-red-600 transition-colors","aria-label":"Delete media",children:e.jsx(_,{size:16})}),m&&e.jsx("button",{onClick:()=>{l&&m&&l({id:t,url:a,mimeType:s,fileName:r})},className:"w-full cursor-pointer "+(o?"aspect-video":""),"aria-label":o?"Play video":"View image",children:e.jsx(u,{url:a,mimeType:s,mode:"thumbnail",alt:r??"Trip media",className:"w-full h-full"})}),!m&&e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsx("div",{className:"truncate text-sm text-white",children:r??"File"}),e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"text-blue-400 text-sm hover:text-blue-300",children:"Open"})]})]})}const se=({items:s,maxItems:r,uploadQueue:i=[],onDeleteItem:n})=>{const[l,o]=t.useState(null),d=r?s.slice(0,r):s;a.useState(null);const m=e=>{if(e.mime_type)return e.mime_type;switch(e.media_type){case"image":return"image/jpeg";case"video":return"video/mp4";default:return"application/octet-stream"}},c=e=>{o(e)};return e.jsxs("div",{className:"space-y-4",children:[i.length>0&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:i.map(t=>e.jsx("div",{className:"relative aspect-square rounded-lg bg-background/50 border border-white/10 overflow-hidden",children:e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center p-4 text-center",children:"uploading"===t.status||"processing"===t.status?e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"w-8 h-8 text-primary animate-spin mb-2"}),e.jsx("p",{className:"text-xs text-foreground/80 mb-2 truncate w-full",children:t.fileName}),e.jsx(E,{value:t.progress,className:"w-full h-2"}),e.jsxs("p",{className:"text-xs text-foreground/60 mt-1",children:[t.progress,"%"]})]}):"complete"===t.status?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-green-500 text-2xl mb-2",children:"âœ“"}),e.jsx("p",{className:"text-xs text-foreground/80 truncate w-full",children:t.fileName})]}):"error"===t.status?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-red-500 text-2xl mb-2",children:"âœ—"}),e.jsx("p",{className:"text-xs text-foreground/80 truncate w-full",children:t.fileName}),e.jsx("p",{className:"text-xs text-red-500/80 mt-1",children:t.error||"Upload failed"})]}):null})},t.fileId))}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:d.map(t=>e.jsx(ae,{id:t.id,url:t.media_url,mimeType:m(t),fileName:t.filename,metadata:t.metadata,onDelete:n,onView:c},t.id))}),r&&s.length>r&&e.jsxs("p",{className:"text-center text-gray-400 text-sm",children:["Showing ",r," of ",s.length," items"]}),l&&e.jsx(h,{media:l,onClose:()=>o(null)})]})};function re(e){try{const t=new URL(e);return t.hash="",[...t.searchParams.keys()].filter(e=>/^utm_|^fbclid$|^gclid$|^igshid$|^si$|^mc_cid$|^mc_eid$/.test(e)).forEach(e=>t.searchParams.delete(e)),"/"!==t.pathname&&t.pathname.endsWith("/")&&(t.pathname=t.pathname.slice(0,-1)),t.hostname=t.hostname.toLowerCase(),t.toString()}catch{return e}}function ie(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch{return""}}function ne(e,t=60){if(e.length<=t)return e;try{const a=new URL(e),s=a.hostname,r=a.pathname+a.search;if(s.length>=t-3)return s.substring(0,t-3)+"...";const i=t-s.length-6;r.substring(0,Math.floor(i/2));return`${s}/...${r.substring(r.length-Math.floor(i/2))}`}catch{const a=Math.floor(t/2)-2;return e.substring(0,a)+"..."+e.substring(e.length-a)}}async function le(e,t={}){var a,s;const{fetchMetadata:r=!0,isDemoMode:i=!1}=t;try{if(i)return function(){const e=Date.now(),t=e=>new Date(e).toISOString();return[{url:"https://www.airbnb.com/rooms/12345678",rawUrl:"https://www.airbnb.com/rooms/12345678?guests=4&adults=4",domain:"airbnb.com",firstSeenAt:t(e-1728e5),lastSeenAt:t(e-1728e5),messageId:"msg-1",postedBy:{id:"user-1",name:"Sarah"},title:"Cozy 3BR Apartment in Downtown"},{url:"https://www.youtube.com/watch?v=abc123",rawUrl:"https://www.youtube.com/watch?v=abc123&t=60s",domain:"youtube.com",firstSeenAt:t(e-864e5),lastSeenAt:t(e-864e5),messageId:"msg-2",postedBy:{id:"user-2",name:"Mike"},title:"Best Places to Visit Guide"}]}();const{data:t,error:l}=await k.from("trip_link_index").select("id, url, created_at, og_title, og_description, og_image_url, domain").eq("trip_id",e).order("created_at",{ascending:!1});if(l)return[];if(!t||0===t.length)return[];const o=new Map;for(const e of t){const t=re(e.url||"");if(o.has(t)){const s=o.get(t);new Date(e.created_at||"")>new Date(s.lastSeenAt)&&(s.lastSeenAt=e.created_at||(new Date).toISOString(),s.messageId=(null==(a=e.id)?void 0:a.toString())||"");continue}const i={url:t,rawUrl:e.url||"",domain:e.domain||ie(e.url||""),firstSeenAt:e.created_at||(new Date).toISOString(),lastSeenAt:e.created_at||(new Date).toISOString(),messageId:(null==(s=e.id)?void 0:s.toString())||"",postedBy:void 0,title:e.og_title||void 0,description:e.og_description||void 0,image:e.og_image_url||void 0};if(r&&(!i.title||!i.description))try{const e=await p(t);e.title&&!i.title&&(i.title=e.title),e.description&&!i.description&&(i.description=e.description),e.image&&!i.image&&(i.image=e.image),i.ogMetadata=e}catch(n){}i.category=x(t,i.ogMetadata),o.set(t,i)}return Array.from(o.values())}catch(l){return[]}}const oe=({tripId:a,onPromoteToTripLink:s})=>{const{user:r}=w(),{isDemoMode:i}=y(),[n,l]=t.useState([]),[d,m]=t.useState(!0),[c,u]=t.useState(null),[h,p]=t.useState(null);t.useEffect(()=>{x()},[a,i]);const x=async()=>{try{m(!0),u(null);const e=await le(a,{isDemoMode:i});l(e)}catch(e){u("Failed to load URLs. Please try again.")}finally{m(!1)}},f=t=>t.includes("youtube")?e.jsx(K,{className:"w-4 h-4 text-red-400"}):t.includes("instagram")?e.jsx(J,{className:"w-4 h-4 text-pink-400"}):t.includes("maps.google")||t.includes("googlemaps")?e.jsx(Q,{className:"w-4 h-4 text-green-400"}):t.includes("ticketmaster")||t.includes("eventbrite")?e.jsx(G,{className:"w-4 h-4 text-purple-400"}):e.jsx(P,{className:"w-4 h-4 text-muted-foreground"}),j=e=>new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return d?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}):c?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(P,{className:"mx-auto h-12 w-12 text-red-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"Error Loading Links"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:c}),e.jsx(b,{onClick:x,variant:"outline",children:"Retry"})]}):0===n.length?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(o,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"No Links Yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Share a URL in Chat and it shows up here automatically"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["Links from Chat (",n.length,")"]})}),e.jsx("div",{className:"space-y-3",children:n.map((t,n)=>{var l,o;return e.jsx("div",{className:"backdrop-blur-sm border rounded-lg p-4 hover:bg-white/10 transition-colors "+(o=t.domain,o.includes("youtube")?"border-red-500/30 bg-red-500/5":o.includes("instagram")?"border-pink-500/30 bg-pink-500/5":o.includes("booking")||o.includes("airbnb")?"border-blue-500/30 bg-blue-500/5":o.includes("maps.google")?"border-green-500/30 bg-green-500/5":o.includes("ticketmaster")||o.includes("eventbrite")?"border-purple-500/30 bg-purple-500/5":o.includes("nytimes")||o.includes("timeout")?"border-yellow-500/30 bg-yellow-500/5":"border-white/10 bg-white/5"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center",children:f(t.domain)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"text-foreground font-medium mb-1",children:t.title||t.domain}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(P,{className:"w-3 h-3 text-muted-foreground flex-shrink-0"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",title:t.url,children:ne(t.url,50)})]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground mb-3",children:[e.jsx("span",{children:j(t.lastSeenAt)}),(null==(l=t.postedBy)?void 0:l.name)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["by ",t.postedBy.name]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>window.open(t.url,"_blank"),className:"text-xs h-8",children:[e.jsx(T,{className:"w-3 h-3 mr-1"}),"Open"]}),e.jsxs(b,{variant:"ghost",size:"sm",onClick:()=>{return e=t.url,navigator.clipboard.writeText(e),void C({title:"Copied!",description:"URL copied to clipboard",variant:"default"});var e},className:"text-xs h-8",children:[e.jsx(V,{className:"w-3 h-3 mr-1"}),"Copy URL"]}),s&&e.jsxs(b,{size:"sm",onClick:()=>(async e=>{if(!a)return void C({title:"Error",description:"Trip ID is required",variant:"destructive"});const t=(null==r?void 0:r.id)||(()=>{let e=sessionStorage.getItem("demo-user-id");return e||(e=`demo-user-${Date.now()}`,sessionStorage.setItem("demo-user-id",e)),e})(),n=e.messageId;p(n);try{await g({tripId:a,url:e.url,title:e.title||ne(e.url,50),description:e.description||`Shared in chat on ${j(e.lastSeenAt)}`,category:"other",addedBy:t},i)&&s&&s(e)}catch(l){}finally{p(null)}})(t),disabled:h===t.messageId,className:"text-xs h-8 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800",children:[e.jsx(W,{className:"w-3 h-3 mr-1"}),h===t.messageId?"Adding...":"Promote to Trip Link"]})]})]})]})},`${t.messageId}-${n}`)})}),e.jsx("div",{className:"mt-6 p-4 bg-white/5 border border-white/10 rounded-lg",children:e.jsxs("p",{className:"text-xs text-muted-foreground",children:["ðŸ’¡ ",e.jsx("strong",{children:"Tip:"}),' Links shared in Chat automatically appear here. Use "Promote to Trip Link" to save important ones to your Places tab.']})})]})};async function de(e){const{tripId:t,query:a,mediaTypes:s=["image","video","document"],limit:r=50,minScore:i=.1}=e;if(!a.trim())return[];try{const[e,n]=await Promise.all([k.from("trip_media_index").select("*").eq("trip_id",t).in("media_type",s).order("created_at",{ascending:!1}),k.from("trip_files").select("*").eq("trip_id",t).order("created_at",{ascending:!1})]),l=[...(e.data||[]).map(e=>({id:e.id,media_url:e.media_url,filename:e.filename||"Untitled",media_type:e.media_type,metadata:e.metadata||{},created_at:e.created_at,source:"chat"})),...(n.data||[]).map(e=>({id:e.id,media_url:`/storage/trip-files/${e.name}`,filename:e.name,media_type:e.file_type,metadata:{extracted_events:e.extracted_events},created_at:e.created_at,source:"upload"}))],o=a.toLowerCase().trim().split(/\s+/).filter(e=>e.length>0),d=l.map(e=>{const t=function(e){var t;const a=[e.filename,e.media_type];e.metadata.tags&&Array.isArray(e.metadata.tags)&&a.push(...e.metadata.tags.map(e=>String(e)));e.metadata.ai_tags&&Array.isArray(e.metadata.ai_tags)&&a.push(...e.metadata.ai_tags.map(e=>String(e)));e.metadata.description&&a.push(String(e.metadata.description));e.metadata.extracted_text&&a.push(String(e.metadata.extracted_text));(null==(t=e.metadata.location)?void 0:t.name)&&a.push(String(e.metadata.location.name));return a.join(" ").toLowerCase()}(e),{score:a,matchedFields:s}=function(e,t,a){let s=0;const r=[];if(a.filename.toLowerCase()===t.join(" "))return s=1,r.push("filename"),{score:s,matchedFields:r};a.filename.toLowerCase().includes(t.join(" "))&&(s+=.8,r.push("filename"));const i=[...Array.isArray(a.metadata.tags)?a.metadata.tags:[],...Array.isArray(a.metadata.ai_tags)?a.metadata.ai_tags:[]],n=i.filter(e=>{const a=String(e).toLowerCase();return t.some(e=>a.includes(e))});n.length>0&&(s+=n.length/i.length*.6,r.push("tags"));if(a.metadata.description){const e=String(a.metadata.description).toLowerCase(),i=t.filter(t=>e.includes(t));i.length>0&&(s+=i.length/t.length*.4,r.push("description"))}const l=t.filter(t=>e.includes(t));return s+=l.length/t.length*.2,s=Math.min(s,1),{score:s,matchedFields:r}}(t,o,e);return{...e,matchScore:a,matchedFields:s}}).filter(e=>e.matchScore>=i).sort((e,t)=>(t.matchScore||0)-(e.matchScore||0)).slice(0,r);return d}catch(n){return[]}}const me=({tripId:a,onSearchResults:s,onSearchChange:r,placeholder:i='Search media... (e.g., "beach photos", "receipts")'})=>{const[n,l]=t.useState(""),[o,d]=t.useState(!1),m=t.useCallback(async e=>{if(e.trim()){d(!0);try{let t;if(/^[#\w\s,]+$/.test(e)&&(e.includes(",")||e.includes("#")||e.split(/\s+/).length<=3)){const s=e.split(/[,#\s]+/).map(e=>e.trim()).filter(e=>e.length>0);t=await async function(e,t){try{const[a,s]=await Promise.all([k.from("trip_media_index").select("*").eq("trip_id",e).order("created_at",{ascending:!1}),k.from("trip_files").select("*").eq("trip_id",e).order("created_at",{ascending:!1})]),r=[...(a.data||[]).map(e=>({id:e.id,media_url:e.media_url,filename:e.filename||"Untitled",media_type:e.media_type,metadata:e.metadata||{},created_at:e.created_at,source:"chat"})),...(s.data||[]).map(e=>({id:e.id,media_url:`/storage/trip-files/${e.name}`,filename:e.name,media_type:e.file_type,metadata:{extracted_events:e.extracted_events},created_at:e.created_at,source:"upload"}))],i=t.map(e=>e.toLowerCase());return r.filter(e=>{const t=[...Array.isArray(e.metadata.tags)?e.metadata.tags:[],...Array.isArray(e.metadata.ai_tags)?e.metadata.ai_tags:[]].map(e=>String(e).toLowerCase());return i.some(e=>t.some(t=>t.includes(e)))})}catch(a){return[]}}(a,s)}else t=await de({tripId:a,query:e,limit:50});s(t)}catch(t){s([])}finally{d(!1)}}else s([])},[a,s]);t.useEffect(()=>{if(!n.trim())return void s([]);const e=setTimeout(()=>{m(n)},300);return()=>clearTimeout(e)},[n,m,s]);return e.jsxs("div",{className:"relative w-full",children:[e.jsxs("div",{className:"relative",children:[e.jsx(H,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Y,{type:"text",value:n,onChange:e=>{const t=e.target.value;l(t),null==r||r(t)},placeholder:i,className:"pl-10 pr-10"}),n&&e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>{l(""),null==r||r(""),s([])},className:"absolute right-1 top-1/2 transform -translate-y-1/2 h-6 w-6 p-0",children:e.jsx(N,{className:"h-4 w-4"})})]}),o&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 text-xs text-muted-foreground px-3",children:"Searching..."})]})};const ce=({tripId:a,onPromoteToTripLink:l})=>{const[o,d]=t.useState("all"),[c,u]=t.useState(0),[h,p]=t.useState(""),[x,g]=t.useState([]),[v,w]=t.useState(!1),[b,N]=t.useState(new Set),{isDemoMode:_}=y(),{mediaItems:k,loading:C,refetch:I}=f(a),A=k.filter(e=>!b.has(e.id)),P=t.useCallback(async e=>{try{_?(N(t=>new Set(t).add(e)),S.success("Item deleted (demo mode)")):(await m.deleteMedia(e),S.success("Item deleted"),null==I||I())}catch(t){S.error("Failed to delete item")}},[_,I]);t.useEffect(()=>{(async()=>{try{const e=await le(a,{isDemoMode:_});u(e.length)}catch(e){}})()},[a,_]);const M=e=>{let t=A;if("photos"===e?t=t.filter(e=>"image"===e.media_type):"videos"===e?t=t.filter(e=>"video"===e.media_type):"files"===e&&(t=t.filter(e=>{var t,a,s;return"document"===e.media_type||"image"===e.media_type&&((null==(t=e.metadata)?void 0:t.isSchedule)||(null==(a=e.metadata)?void 0:a.isReceipt)||(null==(s=e.metadata)?void 0:s.isTicket))})),h&&x.length>0){const e=new Set(x.map(e=>e.id));t=t.filter(t=>e.has(t.id))}else h&&(t=function(e,t){const a=t.toLowerCase().split(/\s+/).filter(e=>e.length>0);return e.filter(e=>{const t=e.metadata||{},s=[...Array.isArray(t.tags)?t.tags:[],...Array.isArray(t.ai_tags)?t.ai_tags:[]].map(e=>String(e).toLowerCase()),r=String(t.ai_category||"").toLowerCase(),i=String(t.ai_description||"").toLowerCase();return a.some(e=>s.some(t=>t.includes(e))||r.includes(e)||i.includes(e))})}(t,h));return t};return C?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(j,{tripId:a,showDetails:!0}),e.jsx(me,{tripId:a,onSearchResults:e=>{g(e),w(!1)},onSearchChange:e=>{p(e),w(e.length>0)}}),e.jsxs(s,{value:o,onValueChange:d,className:"w-full",children:[e.jsxs(r,{className:"grid w-full grid-cols-5 bg-white/5 backdrop-blur-sm",children:[e.jsx(i,{value:"all",className:"text-xs",children:"All"}),e.jsxs(i,{value:"photos",className:"text-xs",children:["Photos",A.filter(e=>"image"===e.media_type).length>0&&e.jsxs("span",{className:"ml-1 text-[10px] opacity-70",children:["(",A.filter(e=>"image"===e.media_type).length,")"]})]}),e.jsxs(i,{value:"videos",className:"text-xs",children:["Videos",A.filter(e=>"video"===e.media_type).length>0&&e.jsxs("span",{className:"ml-1 text-[10px] opacity-70",children:["(",A.filter(e=>"video"===e.media_type).length,")"]})]}),e.jsxs(i,{value:"files",className:"text-xs",children:["Files",A.filter(e=>"document"===e.media_type).length>0&&e.jsxs("span",{className:"ml-1 text-[10px] opacity-70",children:["(",A.filter(e=>"document"===e.media_type).length,")"]})]}),e.jsxs(i,{value:"urls",className:"text-xs",children:["Links",c>0&&e.jsxs("span",{className:"ml-1 text-[10px] opacity-70",children:["(",c,")"]})]})]}),e.jsx(n,{value:"all",className:"mt-6",children:(()=>{const t=M("all");if(0===A.length)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx(U,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"No Media Yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Photos, videos, and files shared in chat or uploaded will appear here automatically"})]});if(h&&0===t.length)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx(U,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"No Results"}),e.jsxs("p",{className:"text-muted-foreground",children:['No media found matching "',h,'". Try a different search term.']})]});const a=t.slice(0,8);return e.jsxs("div",{className:"space-y-4",children:[a.length>0&&e.jsx(se,{items:a,onDeleteItem:P}),t.length>8&&e.jsxs("p",{className:"text-center text-gray-400 text-sm",children:["Showing 8 of ",t.length," items",h&&` matching "${h}"`,!h&&" â€¢ Use tabs above to filter by type"]})]})})()}),e.jsx(n,{value:"photos",className:"mt-6",children:e.jsx(te,{items:M("photos"),type:"photos",searchQuery:h,tripId:a,onMediaUploaded:I,onDeleteItem:P})}),e.jsx(n,{value:"videos",className:"mt-6",children:e.jsx(te,{items:M("videos"),type:"videos",searchQuery:h,tripId:a,onMediaUploaded:I,onDeleteItem:P})}),e.jsx(n,{value:"files",className:"mt-6",children:e.jsx(te,{items:M("files"),type:"files",searchQuery:h,tripId:a,onMediaUploaded:I,onDeleteItem:P})}),e.jsx(n,{value:"urls",className:"mt-6",children:e.jsx(oe,{tripId:a,onPromoteToTripLink:l})})]})]})};export{ce as UnifiedMediaHub};
