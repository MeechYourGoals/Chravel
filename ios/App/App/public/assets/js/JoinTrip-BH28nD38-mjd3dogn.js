import{j as e}from"./ui-vendor-BO3EQrMK-mjd3dogn.js";import{u as t,i as r,j as s,r as i}from"./react-vendor-D1R0t5S0-mjd3dogn.js";import{u as n,s as o,t as a}from"./index-Ta7FH5xW-mjd3dogn.js";import{L as d}from"./loader-circle-C0Dqayt8-mjd3dogn.js";import{C as l}from"./circle-alert-CX60mGhN-mjd3dogn.js";import{C as c}from"./circle-check-CNnkiDfZ-mjd3dogn.js";import{M as m}from"./map-pin-BtCU-LeS-mjd3dogn.js";import{C as u}from"./calendar-C9K0fVga-mjd3dogn.js";import{U as p}from"./users-B07yK8Y7-mjd3dogn.js";import{C as x}from"./clock-CbBGjTQx-mjd3dogn.js";import"./supabase-DyX-XggK-mjd3dogn.js";import"./utils-DD44zzh--mjd3dogn.js";const g="chravel_pending_invite_code",h=()=>{const{token:h}=t(),f=r(),b=s(),{user:v,isLoading:j}=n(),[y,N]=i.useState(!0),[w,_]=i.useState(!1),[I,k]=i.useState(null),[E,S]=i.useState(null),[T,C]=i.useState(!1),R=i.useRef(!1);i.useEffect(()=>{},[]),i.useEffect(()=>{const e=setTimeout(()=>{y&&(N(!1),I||E||S({message:"Failed to load invite details. Please refresh and try again.",code:"NETWORK"}))},5e3);return()=>clearTimeout(e)},[y,I,E]),i.useEffect(()=>{const e=(null==I?void 0:I.trip.name)||"an Amazing Trip",t=(null==I?void 0:I.trip.destination)||"an exciting destination",r=(null==I?void 0:I.trip.cover_image_url)||"https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=1200&h=630&fit=crop";document.title=`Join ${e} - Chravel`;const s=(e,t)=>{let r=document.querySelector(`meta[property="${e}"]`);r||(r=document.createElement("meta"),r.setAttribute("property",e),document.head.appendChild(r)),r.content=t},i=(e,t)=>{let r=document.querySelector(`meta[name="${e}"]`);r||(r=document.createElement("meta"),r.setAttribute("name",e),document.head.appendChild(r)),r.content=t};s("og:title",`Join ${e}!`),s("og:description",`You've been invited to join a trip to ${t}. Click to see details and join the adventure!`),s("og:type","website"),s("og:image",r),i("twitter:card","summary_large_image"),i("twitter:title",`Join ${e}!`),i("twitter:description",`You've been invited to join a trip to ${t}. Click to see details!`),i("twitter:image",r)},[I]),i.useEffect(()=>{const e=sessionStorage.getItem(g);e&&v&&!h&&(sessionStorage.removeItem(g),f(`/join/${e}`,{replace:!0}))},[v,h,f]),i.useEffect(()=>{h?$():(S({message:"Invalid invite link",code:"INVALID"}),N(!1))},[h]);const $=async()=>{h&&await A()},A=async()=>{if(h)if(h.startsWith("demo-"))f(`/auth?mode=signup&returnTo=${encodeURIComponent("/")}`,{replace:!0});else{if(!o)return S({message:"App initialization error. Please refresh the page.",code:"NETWORK"}),void N(!1);try{N(!0);const{data:e,error:t}=await o.functions.invoke("get-invite-preview",{body:{code:h}});if(t)return void S({message:"Failed to load invite details. Please check your connection and try again.",code:"NETWORK"});if(!(null==e?void 0:e.success))return void S({message:(null==e?void 0:e.error)||"Invalid invite link",code:(null==e?void 0:e.error_code)||"INVALID"});0,k(e)}catch(e){S({message:"An unexpected error occurred. Please try again.",code:"NETWORK"})}finally{N(!1)}}else N(!1)};i.useEffect(()=>{v&&h&&I&&(y||w||T||R.current||(R.current=!0,D()))},[v,h,I,y,w,T]);const D=async()=>{if(!v)return h&&sessionStorage.setItem(g,h),void f(`/auth?mode=signin&returnTo=${encodeURIComponent(b.pathname)}`,{replace:!0});if(h&&I){_(!0);try{const{data:e,error:t}=await o.functions.invoke("join-trip",{body:{inviteCode:h}});if(t)return a.error(t.message||"Failed to join trip"),void _(!1);if(!e.success)return a.error(e.message||"Failed to join trip"),void _(!1);if(e.requires_approval)return a.success(e.message||"Join request submitted! You'll see the trip on your home page once approved."),C(!0),_(!1),void setTimeout(()=>{f("/",{replace:!0})},2e3);e.already_member?a.info(e.message||"You're already a member!"):a.success(e.message||"Successfully joined the trip!"),C(!0),setTimeout(()=>{"pro"===e.trip_type?f(`/tour/pro/${e.trip_id}`):"event"===e.trip_type?f(`/event/${e.trip_id}`):f(`/trip/${e.trip_id}`)},1e3)}catch(e){a.error("An unexpected error occurred. Please try again.")}finally{_(!1)}}},q=()=>{if(!(null==I?void 0:I.trip.start_date))return null;const e=new Date(I.trip.start_date).toLocaleDateString("en-US",{month:"short",day:"numeric"});if(I.trip.end_date){return`${e} - ${new Date(I.trip.end_date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`}return e},P=t=>{switch(t){case"EXPIRED":case"INACTIVE":case"MAX_USES":return e.jsx(x,{className:"h-12 w-12 text-yellow-400 mx-auto mb-4"});default:return e.jsx(l,{className:"h-12 w-12 text-red-400 mx-auto mb-4"})}},U=e=>{switch(e){case"EXPIRED":return"Invite Expired";case"INACTIVE":return"Invite Deactivated";case"MAX_USES":return"Invite Limit Reached";case"NOT_FOUND":return"Invite Not Found";case"NETWORK":return"Connection Error";default:return"Invalid Invite"}};if(y)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(d,{className:"h-8 w-8 animate-spin text-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading invite details..."})]})});if(!I&&!E)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center max-w-md bg-card/50 backdrop-blur-md border border-border rounded-3xl p-8 shadow-xl",children:[e.jsx(l,{className:"h-12 w-12 text-yellow-400 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-4",children:"Something went wrong"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"We couldn't load the invite details. Please try again."}),e.jsx("button",{onClick:()=>{N(!0),A()},className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-3 rounded-xl transition-colors",children:"Reload"})]})});if(E)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center max-w-md bg-card/50 backdrop-blur-md border border-border rounded-3xl p-8",children:[P(E.code),e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-4",children:U(E.code)}),e.jsx("p",{className:"text-muted-foreground mb-6",children:E.message}),"NETWORK"===E.code&&e.jsx("button",{onClick:()=>{S(null),N(!0),A()},className:"mb-4 w-full bg-secondary hover:bg-secondary/80 text-secondary-foreground px-6 py-3 rounded-xl transition-colors",children:"Try Again"}),e.jsx("button",{onClick:()=>f("/"),className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-3 rounded-xl transition-colors",children:"Go to Dashboard"})]})});if(T)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center max-w-md bg-card/50 backdrop-blur-md border border-border rounded-3xl p-8",children:[e.jsx(c,{className:"h-12 w-12 text-green-400 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-4",children:(null==I?void 0:I.invite.require_approval)?"Request Submitted!":"Welcome!"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:(null==I?void 0:I.invite.require_approval)?"Your join request has been submitted. The organizer will review it soon.":`You've successfully joined ${null==I?void 0:I.trip.name}!`}),e.jsx(d,{className:"h-6 w-6 animate-spin text-primary mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Redirecting..."})]})});const L=(null==I?void 0:I.trip.cover_image_url)||"https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=800&h=400&fit=crop";return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-card/50 backdrop-blur-md border border-border rounded-3xl overflow-hidden max-w-md w-full",children:[e.jsxs("div",{className:"relative h-48 overflow-hidden",children:[e.jsx("img",{src:L,alt:(null==I?void 0:I.trip.name)||"Trip",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background/90 to-transparent"}),e.jsxs("div",{className:"absolute bottom-4 left-4 right-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:(null==I?void 0:I.trip.name)||"Trip Invitation"}),(null==I?void 0:I.trip.destination)&&e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground mt-1",children:[e.jsx(m,{size:14}),e.jsx("span",{className:"text-sm",children:I.trip.destination})]})]})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"bg-muted/30 border border-border rounded-xl p-4 mb-6 space-y-3",children:[q()&&e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx(u,{size:16,className:"text-primary"}),e.jsx("span",{className:"text-foreground",children:q()})]}),void 0!==(null==I?void 0:I.trip.member_count)&&e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx(p,{size:16,className:"text-primary"}),e.jsxs("span",{className:"text-foreground",children:[I.trip.member_count," ",1===I.trip.member_count?"member":"members"]})]}),(null==I?void 0:I.trip.trip_type)&&"consumer"!==I.trip.trip_type&&e.jsx("div",{className:"inline-flex px-2 py-1 bg-primary/20 text-primary text-xs font-medium rounded-full",children:"pro"===I.trip.trip_type?"Pro Trip":"Event"}),(null==I?void 0:I.invite.expires_at)&&e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsx(x,{size:14}),e.jsxs("span",{children:["Invite expires: ",new Date(I.invite.expires_at).toLocaleDateString()]})]})]}),v?e.jsxs("div",{className:"space-y-4",children:[e.jsx("button",{onClick:D,disabled:w,className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground py-4 px-6 rounded-xl transition-all duration-200 font-medium disabled:opacity-50 flex items-center justify-center gap-2",children:w?e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"h-4 w-4 animate-spin"}),"Joining..."]}):"Join Trip"}),e.jsx("button",{onClick:()=>f("/"),className:"w-full bg-secondary hover:bg-secondary/80 text-secondary-foreground py-3 px-6 rounded-xl transition-colors",children:"Go to Dashboard"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-muted-foreground text-center text-sm",children:"Please log in to join this trip"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{h&&sessionStorage.setItem(g,h),f(`/auth?mode=signin&returnTo=${encodeURIComponent(b.pathname)}`,{replace:!0})},className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground py-3 px-6 rounded-xl transition-all duration-200 font-medium",children:"Log In"}),e.jsx("button",{onClick:()=>{h&&sessionStorage.setItem(g,h),f(`/auth?mode=signup&returnTo=${encodeURIComponent(b.pathname)}`,{replace:!0})},className:"w-full bg-secondary hover:bg-secondary/80 text-secondary-foreground py-3 px-6 rounded-xl transition-colors",children:"Sign Up"})]})]}),(null==I?void 0:I.invite.require_approval)&&!w&&v&&e.jsxs("div",{className:"mt-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(x,{className:"h-5 w-5 text-yellow-400"}),e.jsx("p",{className:"font-medium text-yellow-400",children:"Approval Required"})]}),e.jsx("p",{className:"text-yellow-400/80 text-sm",children:"This trip requires approval from the organizer. Your request will be reviewed once submitted."})]})]})]})})};export{h as default};
